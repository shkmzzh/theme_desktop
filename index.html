<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
      Clock + Drawer + Background + Countdown + Quotes + IP Weather (SVG)
    </title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Inter, 'Helvetica Neue', Arial;
        background: #000;
        overflow: hidden;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      p {
        margin: 0;
        padding: 0;
      }

      /* bg video */
      #bgVideo {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        object-position: center center;
        z-index: 0;
        display: none;
        pointer-events: none;
        background: transparent;
      }

      #clock {
        position: absolute;
        left: 5%;
        top: 8%;
        text-align: center;
        color: #fff;
        z-index: 2;
        cursor: pointer;
        user-select: none;
      }
      #clock .date {
        font-size: 1.2rem;
        opacity: 0.95;
        letter-spacing: 0.08em;
      }
      #clock .time {
        font-size: 6rem;
        margin-top: 6px;
        letter-spacing: 0.04em;
      }

      #overlayText {
        position: fixed;
        inset: 0;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        padding: 20px;
      }
      #overlayText::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.22);
        z-index: -1;
        pointer-events: none;
      }

      #weatherBox {
        display: none;
        color: #fff;
        font-size: 16px;
        padding: 8px 12px;
        border-radius: 10px;
        background: linear-gradient(
          90deg,
          rgba(0, 0, 0, 0.5),
          rgba(0, 0, 0, 0.35)
        );
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.45);
        margin-bottom: 12px;
        pointer-events: auto;
        display: flex;
        gap: 10px;
        align-items: center;
      }
      #weatherIcon {
        width: 44px;
        height: 44px;
        flex: 0 0 44px;
        display: inline-block;
      }
      #weatherSummary {
        font-size: 15px;
      }

      #countdownDisplayMain {
        display: none;
        color: #fff;
        font-size: 20px;
        padding: 8px 14px;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.45);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        margin-bottom: 18px;
        pointer-events: auto;
      }
      #quoteBox {
        color: #fff;
        font-size: 28px;
        max-width: 90%;
        text-align: center;
        padding: 12px 18px;
        border-radius: 8px;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6);
        line-height: 1.35;
        pointer-events: auto;
        min-height: 48px;
        white-space: pre-wrap;
        word-break: break-word;
      }

      /* drawer */
      .drawer-mask {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.42);
        z-index: 9999;
        display: none;
        backdrop-filter: blur(2px);
      }
      .drawer-panel {
        position: absolute;
        top: 0;
        right: 0;
        width: min(420px, 100vw);
        height: 100%;
        background: #fff;
        color: #222;
        overflow-y: auto;
        box-shadow: -12px 0 40px rgba(0, 0, 0, 0.25);
        transform: translateX(100%);
        transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 18px;
        -webkit-overflow-scrolling: touch;
      }
      .drawer-mask.show {
        display: block;
      }
      .drawer-panel.show {
        transform: translateX(0);
      }

      h2 {
        margin: 0 0 8px 0;
        font-size: 18px;
      }
      .drawer-section {
        margin-top: 14px;
        padding-top: 8px;
        border-top: 1px solid #eee;
      }
      .btn {
        display: inline-block;
        width: 100%;
        margin-top: 10px;
        padding: 10px;
        text-align: center;
        background: #409eff;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        user-select: none;
        border: none;
      }
      .muted {
        color: #888;
        font-size: 13px;
        margin-top: 6px;
      }
      input[type='file'] {
        display: none;
      }
      textarea {
        width: 100%;
        resize: vertical;
        min-height: 56px;
      }

      .quote-list {
        margin-top: 8px;
        max-height: 240px;
        overflow: auto;
        padding-right: 6px;
      }
      .quote-item {
        display: flex;
        gap: 6px;
        align-items: center;
        margin-top: 8px;
        background: #f7f7f8;
        padding: 8px;
        border-radius: 6px;
      }
      .quote-item .text {
        flex: 1;
        font-size: 14px;
        color: #222;
        word-break: break-word;
      }
      .quote-item button {
        background: transparent;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 6px;
        font-size: 14px;
      }

      .controls-row {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .small {
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        background: #fff;
        cursor: pointer;
        flex: 1;
        text-align: center;
      }

      .close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 36px;
        height: 36px;
        border-radius: 6px;
        border: none;
        background: rgba(0, 0, 0, 0.04);
        color: #444;
        font-size: 18px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .close-btn:hover {
        background: rgba(0, 0, 0, 0.06);
      }

      pre#weatherRaw {
        max-height: 200px;
        overflow: auto;
        background: #0f1720;
        color: #d7fff3;
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
        white-space: pre-wrap;
      }

      /* responsive */
      @media (max-width: 600px) {
        #clock .time {
          font-size: 48px;
        }
        .drawer-panel {
          padding: 14px;
        }
        #quoteBox {
          font-size: 18px;
          padding: 10px 12px;
        }
        .quote-list {
          max-height: 200px;
        }
        .drawer-panel h2 {
          font-size: 16px;
        }
        .muted {
          font-size: 12px;
        }
        .close-btn {
          top: 10px;
          right: 10px;
          width: 34px;
          height: 34px;
          font-size: 16px;
        }
      }

      /* ========== weather svg styles ========== */
      /* 所有天气 svg 默认隐藏，通过 .show 显示 */
      svg.weather-svg {
        display: none;
        width: 56px;
        height: 56px;
        vertical-align: middle;
        transition: opacity 300ms ease, transform 300ms ease;
        opacity: 0;
        transform: translateY(-6px);
      }
      svg.weather-svg.show {
        display: inline-block;
        opacity: 1;
        transform: translateY(0);
      }
    </style>
  </head>
  <body>
    <video id="bgVideo" autoplay muted loop playsinline></video>

    <div id="clock" title="点击打开设置">
      <div class="date"></div>
      <div class="time"></div>

      <!-- WEATHER SVGs (占位图) -->
      <!-- 请根据需求替换 svg 内容为你自己的图标 -->
      <svg class="weather-svg sunshine" aria-hidden="true" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="4" fill="#FFD54A"></circle>
        <g fill="#FFD54A" opacity="0.9">
          <rect x="11.4" y="1" width="1.2" height="4.2" rx="0.6" />
          <rect x="11.4" y="18.8" width="1.2" height="4.2" rx="0.6" />
          <rect x="1" y="11.4" width="4.2" height="1.2" rx="0.6" />
          <rect x="18.8" y="11.4" width="4.2" height="1.2" rx="0.6" />
          <rect
            x="3.2"
            y="3.2"
            width="1.2"
            height="4.2"
            transform="rotate(-45 3.2 3.2)"
          ></rect>
        </g>
      </svg>

      <svg class="weather-svg sun-cloud" aria-hidden="true" viewBox="0 0 24 24">
        <circle cx="9" cy="9" r="3" fill="#FFD54A"></circle>
        <path
          d="M3 17a4 4 0 0 1 4-4h7a4 4 0 1 1 0 8H7a4 4 0 0 1-4-4z"
          fill="#E0E7FF"
        ></path>
      </svg>

      <svg
        class="weather-svg windy-cloud"
        aria-hidden="true"
        viewBox="0 0 24 24"
      >
        <path
          d="M2 7h12a2 2 0 110 4H6"
          stroke="#A6B3C9"
          stroke-width="1.6"
          fill="none"
          stroke-linecap="round"
        />
        <path
          d="M4 13h9"
          stroke="#A6B3C9"
          stroke-width="1.6"
          fill="none"
          stroke-linecap="round"
        />
      </svg>

      <svg
        class="weather-svg rain-cloud"
        aria-hidden="true"
        viewBox="0 0 24 24"
      >
        <path
          d="M5 15a4 4 0 014-4h6a4 4 0 010 8H9a4 4 0 01-4-4z"
          fill="#E0E7FF"
        ></path>
        <g stroke="#4DA0FF" stroke-width="1.8" stroke-linecap="round">
          <path d="M9 20v2"></path>
          <path d="M12 20v3"></path>
          <path d="M15 20v2"></path>
        </g>
      </svg>

      <svg
        class="weather-svg thunder-cloud"
        aria-hidden="true"
        viewBox="0 0 24 24"
      >
        <path
          d="M6 14a4 4 0 014-4h6a4 4 0 010 8H10a4 4 0 01-4-4z"
          fill="#DDE7FF"
        ></path>
        <path d="M13 18l-2 4 4-1-2 4" fill="#FFD15A"></path>
      </svg>

      <svg
        class="weather-svg snow-cloud"
        aria-hidden="true"
        viewBox="0 0 24 24"
      >
        <path
          d="M5 15a4 4 0 014-4h6a4 4 0 010 8H9a4 4 0 01-4-4z"
          fill="#E8F0FF"
        ></path>
        <g stroke="#BFD8FF" stroke-width="1.6" stroke-linecap="round">
          <path d="M9 20l0.5 0.5 M9 20l-0.5 0.5"></path>
          <path d="M12 20l0.5 0.5 M12 20l-0.5 0.5"></path>
          <path d="M15 20l0.5 0.5 M15 20l-0.5 0.5"></path>
        </g>
      </svg>
    </div>

    <div id="overlayText" aria-hidden="false">
      <div id="weatherBox">
        <img id="weatherIcon" src="" alt="" style="display: none" />
        <div id="weatherSummary"></div>
      </div>
      <div id="countdownDisplayMain">剩余 0 天 00:00:00</div>
      <div id="quoteBox"></div>
    </div>

    <!-- drawer (与之前一致，省略注释) -->
    <div id="drawerMask" class="drawer-mask" aria-hidden="true">
      <div
        id="drawerPanel"
        class="drawer-panel"
        role="dialog"
        aria-modal="true"
        aria-hidden="true"
      >
        <button id="closeDrawerBtn" class="close-btn" aria-label="关闭设置">
          ✕
        </button>
        <h2>设置（背景 / 倒计时 / 励志语 / 天气）</h2>

        <div class="drawer-section">
          <h3>背景</h3>
          <label class="btn" for="pickImg">选择图片背景</label>
          <input id="pickImg" type="file" accept="image/*" />
          <label class="btn" for="pickVideo">选择视频背景</label>
          <input id="pickVideo" type="file" accept="video/*" />
          <div style="margin-top: 10px">
            <strong>展示模式：</strong>
            <label style="margin-left: 10px"
              ><input type="radio" name="bgMode" value="cover" />
              铺满（cover）</label
            >
            <label style="margin-left: 10px"
              ><input type="radio" name="bgMode" value="contain" />
              完整（contain）</label
            >
          </div>
          <div class="muted">
            图片保存到 localStorage（可能失败）。视频 ≤5MB 保存到
            localStorage，>5MB 刷新后不可恢复。
          </div>
        </div>

        <div class="drawer-section">
          <h3>倒计时</h3>
          <input
            id="countdownPicker"
            type="datetime-local"
            style="
              width: 100%;
              padding: 8px;
              border-radius: 6px;
              border: 1px solid #ddd;
            "
          />
          <div class="controls-row">
            <button id="startCountdownBtn" class="small">开始</button>
            <button id="pauseCountdownBtn" class="small">暂停</button>
            <button id="resetCountdownBtn" class="small">重置</button>
          </div>
          <div class="muted">倒计时会显示在背景上，刷新后会自动恢复。</div>
        </div>

        <div class="drawer-section">
          <h3>励志语（打字机效果）</h3>
          <textarea
            id="newQuoteText"
            rows="2"
            placeholder="输入一条励志语..."
          ></textarea>
          <div class="controls-row" style="margin-top: 8px">
            <button id="addQuoteBtn" class="small">添加</button>
            <button
              id="clearQuotesBtn"
              class="small"
              style="background: #f56c6c; color: #fff"
            >
              清空
            </button>
          </div>
          <div class="quote-list" id="quoteList"></div>
          <div class="muted">励志语会按顺序轮播并带打字机效果。</div>
        </div>

        <div class="drawer-section">
          <h3>天气（每 1 小时自动刷新 — 使用 IP 获取）</h3>
          <div style="margin-top: 6px">
            <button id="getWeatherBtn" class="small">
              获取当前天气（通过公网 IP）
            </button>
          </div>

          <div style="margin-top: 10px">
            <label style="font-weight: 600">手动输入 IP（可保存）</label>
            <div style="display: flex; gap: 8px; margin-top: 8px">
              <input
                id="manualIp"
                placeholder="公网 IP，例如：49.234.56.78"
                style="
                  flex: 1;
                  padding: 8px;
                  border-radius: 6px;
                  border: 1px solid #ddd;
                "
              />
            </div>
            <div class="controls-row" style="margin-top: 8px">
              <button id="saveIpBtn" class="small">保存并获取</button>
              <button
                id="clearIpBtn"
                class="small"
                style="background: #f56c6c; color: #fff"
              >
                清除 IP
              </button>
            </div>
            <div class="muted" style="margin-top: 8px">
              保存后会覆盖之前的 IP 并立即请求天气。
            </div>
          </div>

          <div style="margin-top: 8px">
            <div class="muted">
              已保存 IP（键：<code>app_weather_ip</code>），最近一次天气保存在
              <code>app_weather_last</code>。
            </div>
          </div>
          <div style="margin-top: 10px">
            <strong>已保存 IP：</strong>
            <div id="savedIp" class="muted" style="margin-top: 6px">
              （尚未保存）
            </div>
            <div style="margin-top: 6px">
              <strong>上次刷新：</strong
              ><span id="weatherLast" class="muted">（尚未刷新）</span>
            </div>
          </div>
          <div style="margin-top: 10px">
            <strong>接口返回（调试）</strong>
            <pre id="weatherRaw">尚未获取</pre>
          </div>
        </div>

        <div class="drawer-section">
          <h3>重置</h3>
          <div class="muted" style="margin-bottom: 8px">
            重置将清除背景、倒计时、励志语、天气缓存与展示模式。
          </div>
          <button
            id="resetAllBtn"
            class="btn"
            style="background: #333; margin-top: 6px"
          >
            重置所有设置
          </button>
        </div>

        <div style="height: 40px"></div>
      </div>
    </div>

    <script>
      // 存储键
      const KEY_BG_IMAGE = 'app_bg_image_data';
      const KEY_BG_VIDEO = 'app_bg_video_data';
      const KEY_BG_MODE = 'app_bg_mode';
      const KEY_COUNTDOWN = 'app_countdown_target';
      const KEY_QUOTES = 'app_quotes_list';
      const KEY_WEATHER_IP = 'app_weather_ip';
      const KEY_WEATHER_LAST = 'app_weather_last';

      // 元素引用
      const dateEl = document.querySelector('#clock .date');
      const timeEl = document.querySelector('#clock .time');
      const clockEl = document.getElementById('clock');

      const bgVideo = document.getElementById('bgVideo');
      const weatherBox = document.getElementById('weatherBox');
      const weatherIcon = document.getElementById('weatherIcon');
      const weatherSummary = document.getElementById('weatherSummary');
      const weatherRawPre = document.getElementById('weatherRaw');
      const savedIpEl = document.getElementById('savedIp');
      const weatherLastEl = document.getElementById('weatherLast');

      const countdownDisplayMain = document.getElementById(
        'countdownDisplayMain'
      );
      const quoteBox = document.getElementById('quoteBox');

      const drawerMask = document.getElementById('drawerMask');
      const drawerPanel = document.getElementById('drawerPanel');
      const closeDrawerBtn = document.getElementById('closeDrawerBtn');

      const pickImg = document.getElementById('pickImg');
      const pickVideo = document.getElementById('pickVideo');
      const modeRadios = document.getElementsByName('bgMode');

      const countdownPicker = document.getElementById('countdownPicker');
      const startCountdownBtn = document.getElementById('startCountdownBtn');
      const pauseCountdownBtn = document.getElementById('pauseCountdownBtn');
      const resetCountdownBtn = document.getElementById('resetCountdownBtn');

      const newQuoteText = document.getElementById('newQuoteText');
      const addQuoteBtn = document.getElementById('addQuoteBtn');
      const clearQuotesBtn = document.getElementById('clearQuotesBtn');
      const quoteListEl = document.getElementById('quoteList');

      const getWeatherBtn = document.getElementById('getWeatherBtn');
      const resetAllBtn = document.getElementById('resetAllBtn');

      const manualIp = document.getElementById('manualIp');
      const saveIpBtn = document.getElementById('saveIpBtn');
      const clearIpBtn = document.getElementById('clearIpBtn');

      let lastObjectURL = null;
      let weatherAutoTimer = null;

      function revokeLastURL() {
        if (lastObjectURL) {
          try {
            URL.revokeObjectURL(lastObjectURL);
          } catch (e) {}
          lastObjectURL = null;
        }
      }
      function safeSetItem(k, v) {
        try {
          localStorage.setItem(k, v);
          return true;
        } catch (e) {
          console.warn('localStorage set failed', e);
          return false;
        }
      }

      /* clock */
      function updateClock() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const weekArr = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const w = weekArr[now.getDay()];
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        dateEl.textContent = `${y}-${m}-${d} ${w}`;
        timeEl.textContent = `${hh}:${mm}:${ss}`;
      }
      updateClock();
      setInterval(updateClock, 1000);

      /* drawer open/close */
      function openDrawer() {
        drawerMask.classList.add('show');
        drawerPanel.classList.add('show');
        drawerMask.setAttribute('aria-hidden', 'false');
        drawerPanel.setAttribute('aria-hidden', 'false');
        drawerMask.addEventListener('click', maskClickHandler);
      }
      function closeDrawer() {
        drawerMask.classList.remove('show');
        drawerPanel.classList.remove('show');
        drawerMask.setAttribute('aria-hidden', 'true');
        drawerPanel.setAttribute('aria-hidden', 'true');
        drawerMask.removeEventListener('click', maskClickHandler);
      }
      function maskClickHandler(e) {
        if (e.target === drawerMask) closeDrawer();
      }
      clockEl.addEventListener('click', openDrawer);
      closeDrawerBtn.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeDrawer();
      });

      /* background handlers (与之前逻辑一致) */
      function applyMode(mode) {
        if (document.body.style.backgroundImage) {
          document.body.style.backgroundSize =
            mode === 'cover' ? 'cover' : 'contain';
          document.body.style.backgroundRepeat = 'no-repeat';
          document.body.style.backgroundPosition = 'center center';
          if (bgVideo.style.display === 'block')
            document.body.style.backgroundColor = 'transparent';
          else
            document.body.style.backgroundColor =
              mode === 'contain' ? '#000' : 'transparent';
        }
        if (bgVideo.style.display !== 'none') {
          bgVideo.style.objectFit = mode === 'cover' ? 'cover' : 'contain';
          document.body.style.backgroundColor = 'transparent';
        }
        safeSetItem(KEY_BG_MODE, mode);
      }
      (function restoreModeUI() {
        const saved = localStorage.getItem(KEY_BG_MODE) || 'cover';
        for (const r of modeRadios) r.checked = r.value === saved;
        applyMode(saved);
      })();
      for (const r of modeRadios)
        r.addEventListener('change', () => {
          const v = document.querySelector(
            'input[name="bgMode"]:checked'
          ).value;
          applyMode(v);
        });

      pickImg.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (evt) {
          const dataURL = evt.target.result;
          revokeLastURL();
          document.body.style.backgroundImage = `url("${dataURL}")`;
          const mode = localStorage.getItem(KEY_BG_MODE) || 'cover';
          document.body.style.backgroundSize =
            mode === 'cover' ? 'cover' : 'contain';
          document.body.style.backgroundPosition = 'center center';
          document.body.style.backgroundRepeat = 'no-repeat';
          try {
            bgVideo.pause();
            bgVideo.removeAttribute('src');
            bgVideo.load();
          } catch (e) {}
          bgVideo.style.display = 'none';
          if (!safeSetItem(KEY_BG_IMAGE, dataURL)) {
            alert('图片过大，无法保存到本地，但本次会话仍会显示。');
            localStorage.removeItem(KEY_BG_IMAGE);
          } else localStorage.removeItem(KEY_BG_VIDEO);
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      pickVideo.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const maxPersist = 5 * 1024 * 1024;
        if (file.size <= maxPersist) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            const dataURL = evt.target.result;
            revokeLastURL();
            bgVideo.src = dataURL;
            bgVideo.style.display = 'block';
            const mode = localStorage.getItem(KEY_BG_MODE) || 'cover';
            bgVideo.style.objectFit = mode === 'cover' ? 'cover' : 'contain';
            bgVideo.muted = true;
            bgVideo.play().catch(() => {});
            document.body.style.backgroundImage = '';
            if (!safeSetItem(KEY_BG_VIDEO, dataURL)) {
              alert(
                '视频无法保存到 localStorage（可能过大），但本次会话会播放。'
              );
              localStorage.removeItem(KEY_BG_VIDEO);
            } else localStorage.removeItem(KEY_BG_IMAGE);
          };
          reader.readAsDataURL(file);
        } else {
          revokeLastURL();
          const url = URL.createObjectURL(file);
          lastObjectURL = url;
          bgVideo.src = url;
          bgVideo.style.display = 'block';
          const mode = localStorage.getItem(KEY_BG_MODE) || 'cover';
          bgVideo.style.objectFit = mode === 'cover' ? 'cover' : 'contain';
          bgVideo.muted = true;
          bgVideo.play().catch(() => {});
          document.body.style.backgroundImage = '';
          localStorage.removeItem(KEY_BG_VIDEO);
          localStorage.removeItem(KEY_BG_IMAGE);
          alert(
            '视频体积较大（>5MB），无法保存到 localStorage，刷新后将无法恢复该视频。'
          );
        }
        e.target.value = '';
      });

      function restoreBackground() {
        const img = localStorage.getItem(KEY_BG_IMAGE);
        const vid = localStorage.getItem(KEY_BG_VIDEO);
        const mode = localStorage.getItem(KEY_BG_MODE) || 'cover';
        if (img) {
          document.body.style.backgroundImage = `url("${img}")`;
          document.body.style.backgroundSize =
            mode === 'cover' ? 'cover' : 'contain';
          document.body.style.backgroundPosition = 'center center';
          document.body.style.backgroundRepeat = 'no-repeat';
          document.body.style.backgroundColor =
            mode === 'contain' ? '#000' : 'transparent';
          bgVideo.style.display = 'none';
        } else if (vid) {
          bgVideo.src = vid;
          bgVideo.style.display = 'block';
          bgVideo.style.objectFit = mode === 'cover' ? 'cover' : 'contain';
          bgVideo.muted = true;
          bgVideo.play().catch(() => {});
          document.body.style.backgroundImage = '';
          document.body.style.backgroundColor = 'transparent';
        } else {
          document.body.style.backgroundImage = '';
          document.body.style.backgroundColor = '#000';
          bgVideo.style.display = 'none';
        }
      }
      restoreBackground();

      /* countdown */
      let countdownTarget = null,
        countdownRunning = false,
        countdownInterval = null,
        pausedRemaining = null;
      function renderCountdownOnce() {
        if (!countdownTarget && pausedRemaining == null) {
          countdownDisplayMain.style.display = 'none';
          return;
        }
        countdownDisplayMain.style.display = 'inline-block';
        let remaining;
        if (countdownRunning && countdownTarget)
          remaining = countdownTarget - Date.now();
        else if (!countdownRunning && pausedRemaining != null)
          remaining = pausedRemaining;
        else if (countdownTarget) remaining = countdownTarget - Date.now();
        else remaining = 0;
        if (remaining <= 0) {
          countdownDisplayMain.textContent = '倒计时结束！';
          clearInterval(countdownInterval);
          countdownInterval = null;
          countdownRunning = false;
          localStorage.removeItem(KEY_COUNTDOWN);
          return;
        }
        const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
        const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24);
        const mins = Math.floor((remaining / (1000 * 60)) % 60);
        const secs = Math.floor((remaining / 1000) % 60);
        countdownDisplayMain.textContent = `剩余 ${days} 天 ${String(
          hours
        ).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(
          secs
        ).padStart(2, '0')}`;
      }
      function startCountdown(ts) {
        if (!ts || ts <= Date.now()) {
          alert('请选择未来的目标时间');
          return;
        }
        countdownTarget = ts;
        pausedRemaining = null;
        countdownRunning = true;
        safeSetItem(KEY_COUNTDOWN, String(ts));
        if (countdownInterval) clearInterval(countdownInterval);
        renderCountdownOnce();
        countdownInterval = setInterval(renderCountdownOnce, 1000);
      }
      function pauseCountdown() {
        if (!countdownRunning || !countdownTarget) return;
        pausedRemaining = countdownTarget - Date.now();
        countdownRunning = false;
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        renderCountdownOnce();
      }
      function resetCountdown() {
        if (!confirm('确认重置（清除）倒计时？')) return;
        countdownTarget = null;
        pausedRemaining = null;
        countdownRunning = false;
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        localStorage.removeItem(KEY_COUNTDOWN);
        renderCountdownOnce();
      }
      startCountdownBtn.addEventListener('click', () => {
        const val = countdownPicker.value;
        if (!val && pausedRemaining == null) {
          alert('请选择目标时间或恢复已暂停的倒计时');
          return;
        }
        if (pausedRemaining != null && !val) {
          countdownTarget = Date.now() + pausedRemaining;
          pausedRemaining = null;
          countdownRunning = true;
          if (countdownInterval) clearInterval(countdownInterval);
          countdownInterval = setInterval(renderCountdownOnce, 1000);
          renderCountdownOnce();
          closeDrawer();
          return;
        }
        const ts = new Date(val).getTime();
        startCountdown(ts);
        closeDrawer();
        countdownPicker.value = '';
      });
      pauseCountdownBtn.addEventListener('click', pauseCountdown);
      resetCountdownBtn.addEventListener('click', resetCountdown);
      function restoreCountdown() {
        const saved = localStorage.getItem(KEY_COUNTDOWN);
        if (saved) {
          const ts = Number(saved);
          if (!isNaN(ts) && ts > Date.now()) {
            countdownTarget = ts;
            countdownRunning = true;
            renderCountdownOnce();
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(renderCountdownOnce, 1000);
            countdownPicker.value = new Date(ts).toISOString().slice(0, 16);
          } else localStorage.removeItem(KEY_COUNTDOWN);
        }
      }
      restoreCountdown();

      /* quotes */
      function loadQuotes() {
        const raw = localStorage.getItem(KEY_QUOTES);
        if (!raw) return [];
        try {
          return JSON.parse(raw);
        } catch (e) {
          return [];
        }
      }
      function saveQuotes(arr) {
        safeSetItem(KEY_QUOTES, JSON.stringify(arr));
      }
      function renderQuoteList() {
        const arr = loadQuotes();
        quoteListEl.innerHTML = '';
        if (arr.length === 0) {
          quoteListEl.innerHTML =
            '<div class="muted" style="margin-top:8px;">当前无励志语，添加几条吧。</div>';
          return;
        }
        arr.forEach((q, idx) => {
          const item = document.createElement('div');
          item.className = 'quote-item';
          const t = document.createElement('div');
          t.className = 'text';
          t.textContent = q;
          item.appendChild(t);
          const up = document.createElement('button');
          up.textContent = '↑';
          up.title = '上移';
          const down = document.createElement('button');
          down.textContent = '↓';
          down.title = '下移';
          const del = document.createElement('button');
          del.textContent = '✕';
          del.title = '删除';
          item.appendChild(up);
          item.appendChild(down);
          item.appendChild(del);
          up.addEventListener('click', () => {
            if (idx === 0) return;
            const arr = loadQuotes();
            [arr[idx - 1], arr[idx]] = [arr[idx], arr[idx - 1]];
            saveQuotes(arr);
            renderQuoteList();
          });
          down.addEventListener('click', () => {
            const arr = loadQuotes();
            if (idx === arr.length - 1) return;
            [arr[idx + 1], arr[idx]] = [arr[idx], arr[idx + 1]];
            saveQuotes(arr);
            renderQuoteList();
          });
          del.addEventListener('click', () => {
            if (!confirm('确认删除该励志语？')) return;
            const arr = loadQuotes();
            arr.splice(idx, 1);
            saveQuotes(arr);
            renderQuoteList();
          });
          quoteListEl.appendChild(item);
        });
      }
      renderQuoteList();
      addQuoteBtn.addEventListener('click', () => {
        const txt = newQuoteText.value.trim();
        if (!txt) {
          alert('请输入励志语');
          return;
        }
        const arr = loadQuotes();
        arr.push(txt);
        saveQuotes(arr);
        newQuoteText.value = '';
        renderQuoteList();
        startQuoteCycleOnce();
      });
      clearQuotesBtn.addEventListener('click', () => {
        if (!confirm('确认清空所有励志语？')) return;
        saveQuotes([]);
        renderQuoteList();
        stopQuoteCycle();
        quoteBox.textContent = '';
      });

      let quoteCyclePromise = null;
      let quoteCycleActive = true;
      const TYPING_SPEED = 40,
        ERASING_SPEED = 20,
        PAUSE_AFTER_TYPE = 1800,
        PAUSE_AFTER_ERASE = 300;
      function typeText(element, text) {
        return new Promise((res) => {
          element.textContent = '';
          let i = 0;
          function step() {
            if (!quoteCycleActive) {
              res();
              return;
            }
            if (i <= text.length - 1) {
              element.textContent += text.charAt(i);
              i++;
              setTimeout(step, TYPING_SPEED);
            } else res();
          }
          step();
        });
      }
      function eraseText(element) {
        return new Promise((res) => {
          let s = element.textContent || '';
          let i = s.length;
          function step() {
            if (!quoteCycleActive) {
              res();
              return;
            }
            if (i > 0) {
              element.textContent = s.substring(0, i - 1);
              i--;
              setTimeout(step, ERASING_SPEED);
            } else res();
          }
          step();
        });
      }
      async function quoteCycleLoop() {
        quoteCycleActive = true;
        const arr = loadQuotes();
        if (!arr || arr.length === 0) {
          quoteBox.textContent = '';
          return;
        }
        let idx = 0;
        while (quoteCycleActive) {
          const cur = loadQuotes();
          if (!cur || cur.length === 0) {
            quoteBox.textContent = '';
            break;
          }
          if (idx >= cur.length) idx = 0;
          const text = cur[idx];
          await typeText(quoteBox, text);
          if (!quoteCycleActive) break;
          await new Promise((r) => setTimeout(r, PAUSE_AFTER_TYPE));
          if (!quoteCycleActive) break;
          await eraseText(quoteBox);
          if (!quoteCycleActive) break;
          await new Promise((r) => setTimeout(r, PAUSE_AFTER_ERASE));
          idx++;
        }
        quoteCyclePromise = null;
      }
      function startQuoteCycleOnce() {
        if (quoteCyclePromise) return;
        quoteCyclePromise = (async () => {
          try {
            await quoteCycleLoop();
          } catch (e) {
            console.warn(e);
          }
          quoteCyclePromise = null;
        })();
      }
      function stopQuoteCycle() {
        quoteCycleActive = false;
        quoteCyclePromise = null;
      }
      if (loadQuotes().length > 0) startQuoteCycleOnce();

      /* ========== WEATHER (IP-based) ========== */
      const PUBLIC_WEATHER_ID = '88888888';
      const PUBLIC_WEATHER_KEY = '88888888';

      function extractWeatherSummary(json) {
        const result = {
          city: null,
          temp: null,
          desc: null,
          humidity: null,
          wind: null,
          icon: null,
          raw: json,
        };
        function walk(obj) {
          if (!obj || typeof obj !== 'object') return;
          for (const k of Object.keys(obj)) {
            const v = obj[k];
            const key = k.toLowerCase();
            if (
              !result.city &&
              (key.includes('city') ||
                key.includes('name') ||
                key.includes('location') ||
                key.includes('addr') ||
                key.includes('county'))
            ) {
              if (typeof v === 'string') result.city = v;
            }
            if (
              !result.temp &&
              (key.includes('temp') ||
                key.includes('tem') ||
                key.includes('wendu') ||
                key.includes('temperature'))
            ) {
              if (typeof v === 'number' || typeof v === 'string')
                result.temp = v;
            }
            if (
              !result.desc &&
              (key.includes('wea') ||
                key.includes('weather') ||
                key.includes('desc') ||
                key.includes('text') ||
                key.includes('info'))
            ) {
              if (typeof v === 'string') result.desc = v;
            }
            if (
              !result.humidity &&
              (key.includes('humidity') || key.includes('shidu'))
            ) {
              if (typeof v === 'number' || typeof v === 'string')
                result.humidity = v;
            }
            if (
              !result.wind &&
              (key.includes('wind') || key.includes('feng'))
            ) {
              if (typeof v === 'string') result.wind = v;
            }
            if (
              !result.icon &&
              (key.includes('icon') ||
                key.includes('img') ||
                key.includes('pict') ||
                key.includes('image'))
            ) {
              if (typeof v === 'string') result.icon = v;
            }
            if (typeof v === 'object') walk(v);
          }
        }
        walk(json);
        return result;
      }

      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (m) =>
            ({
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#39;',
            }[m])
        );
      }

      function showWeatherSummary(summary) {
        if (!summary) {
          weatherBox.style.display = 'none';
          return;
        }
        const pieces = [];
        if (summary.city)
          pieces.push(`<strong>${escapeHtml(String(summary.city))}</strong>`);
        if (summary.temp != null)
          pieces.push(`${escapeHtml(String(summary.temp))} ℃`);
        if (summary.desc) pieces.push(escapeHtml(String(summary.desc)));
        if (summary.humidity)
          pieces.push(`湿度: ${escapeHtml(String(summary.humidity))}`);
        if (summary.wind)
          pieces.push(`风: ${escapeHtml(String(summary.wind))}`);
        weatherSummary.innerHTML = pieces.join(' · ');
        if (summary.icon) {
          weatherIcon.src = summary.icon;
          weatherIcon.style.display = 'inline-block';
        } else {
          weatherIcon.style.display = 'none';
        }
        weatherBox.style.display = 'flex';
      }

      async function fetchWeatherWithIP(ip) {
        const base = 'https://cn.apihz.cn/api/tianqi/tengxunip.php';
        const url = `${base}?id=${encodeURIComponent(
          PUBLIC_WEATHER_ID
        )}&key=${encodeURIComponent(
          PUBLIC_WEATHER_KEY
        )}&ip=${encodeURIComponent(ip)}`;
        weatherRawPre.textContent = '请求中...';
        try {
          const resp = await fetch(url);
          if (!resp.ok) throw new Error('网络错误: ' + resp.status);
          const data = await resp.json();
          console.log(resp, data);
          if (data.code == 200) {
            weatherRawPre.textContent = JSON.stringify(data, null, 2);
            safeSetItem(
              KEY_WEATHER_LAST,
              JSON.stringify({ ts: Date.now(), query: { ip }, data })
            );
            safeSetItem(KEY_WEATHER_IP, ip);
            updateSavedIpUI();
            updateLastFetchUI();
            const summary = extractWeatherSummary(data);
            showWeatherSummary(summary);
            // 同时显示对应 svg（关键点）
            if (typeof showSvgFromSummary === 'function')
              showSvgFromSummary(summary);
          }
           return { ok: true, data };
        } catch (err) {
          console.error('fetchWeather error', err);
          weatherRawPre.textContent = '请求失败: ' + err.message;
          showWeatherSummary(null);
          // 隐藏 svg
          if (typeof hideAllWeatherSVG === 'function') hideAllWeatherSVG();
          return { ok: false, error: err };
        }
      }

      // 检测公网 IP（优先 ipify，失败再尝试 ifconfig.co）
      async function detectPublicIp() {
        try {
          const resp = await fetch('https://api.ipify.org?format=json');
          if (!resp.ok) throw new Error('ipify 网络错误: ' + resp.status);
          const j = await resp.json();
          return String(j.ip || '').trim();
        } catch (err) {
          console.warn('detectPublicIp failed', err);
          try {
            const resp2 = await fetch('https://ifconfig.co/json');
            if (!resp2.ok) return '';
            const j2 = await resp2.json();
            return String(j2.ip || '').trim();
          } catch (e) {
            return '';
          }
        }
      }

      async function getWeatherHandler() {
        weatherRawPre.textContent = '正在检测公网 IP...';
        const ip = await detectPublicIp();
        if (!ip) {
          alert('无法检测到公网 IP，请手动输入 IP 并保存。');
          weatherRawPre.textContent = '无法检测公网 IP';
          return;
        }
        weatherRawPre.textContent = `已检测到公网 IP：${ip}，正在请求天气接口...`;
        await fetchWeatherWithIP(ip);
      }
      getWeatherBtn.addEventListener('click', getWeatherHandler);

      // 保存并使用手动 IP
      saveIpBtn.addEventListener('click', async () => {
        const ip = (manualIp.value || '').trim();
        if (!ip) {
          alert('请输入有效的公网 IP');
          return;
        }
        safeSetItem(KEY_WEATHER_IP, ip);
        updateSavedIpUI();
        weatherRawPre.textContent = `手动保存：ip=${ip}，正在请求天气接口...`;
        await fetchWeatherWithIP(ip);
        closeDrawer();
      });

      // 清除 IP
      clearIpBtn.addEventListener('click', () => {
        if (!confirm('确认清除已保存的 IP？')) return;
        localStorage.removeItem(KEY_WEATHER_IP);
        updateSavedIpUI();
        manualIp.value = '';
        alert('已清除保存的 IP');
      });

      async function fetchWeatherAutoOnce() {
        const ipRaw = localStorage.getItem(KEY_WEATHER_IP);
        if (ipRaw) {
          try {
            const ip = String(ipRaw).trim();
            if (ip) {
              await fetchWeatherWithIP(ip);
              try {
                manualIp.value = ip;
              } catch (e) {}
              return;
            }
          } catch (e) {}
        }
        const detected = await detectPublicIp();
        if (!detected) {
          console.warn('无法自动检测公网 IP，等待用户手动输入或点击获取');
          return;
        }
        try {
          manualIp.value = detected;
        } catch (e) {}
        await fetchWeatherWithIP(detected);
      }

      function startAutoWeatherHourly() {
        if (weatherAutoTimer) clearInterval(weatherAutoTimer);
        fetchWeatherAutoOnce();
        weatherAutoTimer = setInterval(fetchWeatherAutoOnce, 60 * 60 * 1000);
      }

      function updateSavedIpUI() {
        const s = localStorage.getItem(KEY_WEATHER_IP);
        if (!s) {
          savedIpEl.textContent = '（尚未保存）';
          return;
        }
        savedIpEl.textContent = `ip=${s}`;
      }
      function updateLastFetchUI() {
        const lastRaw = localStorage.getItem(KEY_WEATHER_LAST);
        if (!lastRaw) {
          weatherLastEl.textContent = '（尚未刷新）';
          return;
        }
        try {
          const parsed = JSON.parse(lastRaw);
          const ts = parsed.ts || Date.now();
          const d = new Date(ts);
          weatherLastEl.textContent = `${d.getFullYear()}-${String(
            d.getMonth() + 1
          ).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(
            d.getHours()
          ).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
        } catch (e) {
          weatherLastEl.textContent = '（解析失败）';
        }
      }

      (function restoreWeatherUI() {
        const last = localStorage.getItem(KEY_WEATHER_LAST);
        if (last) {
          try {
            const parsed = JSON.parse(last);
            weatherRawPre.textContent = JSON.stringify(parsed.data, null, 2);
            const summary = extractWeatherSummary(parsed.data);
            showWeatherSummary(summary);
            if (typeof showSvgFromSummary === 'function')
              showSvgFromSummary(summary);
          } catch (e) {
            weatherRawPre.textContent = '尚未获取';
          }
        } else weatherRawPre.textContent = '尚未获取';
        updateSavedIpUI();
        updateLastFetchUI();
        try {
          const ipRaw = localStorage.getItem(KEY_WEATHER_IP);
          if (ipRaw) manualIp.value = String(ipRaw);
        } catch (e) {}
        startAutoWeatherHourly();
      })();

      /* ========== SVG 显示逻辑 ========== */
      (function () {
        const SVG_CLASSES = [
          'sunshine',
          'sun-cloud',
          'windy-cloud',
          'rain-cloud',
          'thunder-cloud',
          'snow-cloud',
        ];

        // 隐藏所有 svg（暴露给外部）
        window.hideAllWeatherSVG = function () {
          document.querySelectorAll('svg.weather-svg').forEach((el) => {
            el.classList.remove('show');
            el.setAttribute('aria-hidden', 'true');
          });
        };

        // 初始化隐藏
        try {
          hideAllWeatherSVG();
        } catch (e) {}

        function mapDescToType(desc) {
          if (!desc) return 'sunshine';
          const s = String(desc || '').toLowerCase();
          if (/thunder|storm|雷|闪电|雷阵雨/.test(s)) return 'thunder-cloud';
          if (/snow|下雪|雪|冰雹|sleet|hail/.test(s)) return 'snow-cloud';
          if (/rain|shower|下雨|阵雨|降雨|drizzle/.test(s)) return 'rain-cloud';
          if (/wind|windy|风|大风|狂风|breeze/.test(s)) return 'windy-cloud';
          if (/cloud|cloudy|overcast|多云|阴|云/.test(s)) {
            if (/partly|晴间|sunny intervals/.test(s)) return 'sun-cloud';
            return 'sun-cloud';
          }
          if (/sun|clear|晴|晴朗/.test(s)) return 'sunshine';
          return 'sunshine';
        }

        window.showSvgFromSummary = function (summary) {
          try {
            // 若 summary 带 icon（图片），优先显示图片并隐藏 svg（可按需修改）
            if (summary && summary.icon) {
              hideAllWeatherSVG();
              if (weatherIcon) {
                weatherIcon.src = summary.icon;
                weatherIcon.style.display = 'inline-block';
              }
              return;
            }
            const desc =
              (summary && (summary.desc || summary.text || '')) || '';
            const type = mapDescToType(desc);
            // 隐藏图片 icon（使用 svg）
            if (weatherIcon) weatherIcon.style.display = 'none';
            // 显示匹配的 svg
            hideAllWeatherSVG();
            const el = document.querySelector('svg.weather-svg.' + type);
            if (el) {
              el.classList.add('show');
              el.setAttribute('aria-hidden', 'false');
            }
          } catch (e) {
            console.warn('showSvgFromSummary failed', e);
            hideAllWeatherSVG();
          }
        };
      })();

      /* restore all & reset */
      (function restoreAll() {
        restoreBackground();
        restoreCountdown();
        renderQuoteList();
        if (loadQuotes().length > 0) startQuoteCycleOnce();
      })();

      resetAllBtn.addEventListener('click', () => {
        if (
          !confirm(
            '确认重置所有设置？这将清除背景、倒计时、励志语、天气缓存与展示模式。'
          )
        )
          return;
        localStorage.removeItem(KEY_BG_IMAGE);
        localStorage.removeItem(KEY_BG_VIDEO);
        localStorage.removeItem(KEY_BG_MODE);
        localStorage.removeItem(KEY_COUNTDOWN);
        localStorage.removeItem(KEY_QUOTES);
        localStorage.removeItem(KEY_WEATHER_IP);
        localStorage.removeItem(KEY_WEATHER_LAST);
        try {
          bgVideo.pause();
          bgVideo.removeAttribute('src');
          bgVideo.load();
        } catch (e) {}
        bgVideo.style.display = 'none';
        revokeLastURL();
        document.body.style.backgroundImage = '';
        document.body.style.backgroundColor = '#000';
        if (countdownInterval) {
          clearInterval(countdownInterval);
          countdownInterval = null;
        }
        countdownTarget = null;
        pausedRemaining = null;
        countdownRunning = false;
        countdownDisplayMain.style.display = 'none';
        stopQuoteCycle();
        saveQuotes([]);
        renderQuoteList();
        quoteBox.textContent = '';
        weatherRawPre.textContent = '尚未获取';
        weatherBox.style.display = 'none';
        savedIpEl.textContent = '（尚未保存）';
        weatherLastEl.textContent = '（尚未刷新）';
        if (weatherAutoTimer) {
          clearInterval(weatherAutoTimer);
          weatherAutoTimer = null;
        }
        manualIp.value = '';
        for (const r of modeRadios) r.checked = r.value === 'cover';
        safeSetItem(KEY_BG_MODE, 'cover');
        // 隐藏 svg
        try {
          hideAllWeatherSVG();
        } catch (e) {}
        closeDrawer();
        alert('已重置所有设置为默认。');
      });

      window.addEventListener('beforeunload', () => {
        revokeLastURL();
        if (weatherAutoTimer) clearInterval(weatherAutoTimer);
      });
    </script>
  </body>
</html>
