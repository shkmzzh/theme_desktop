<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
      Clock + Drawer + Background + Multi-Countdown + Quotes + IP Weather (SVG)
      - Enhanced
    </title>
    <link rel="stylesheet" href="./index.css" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Inter, 'Helvetica Neue', Arial;
        background: #000;
        overflow: hidden;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      p {
        margin: 0;
        padding: 0;
        color: #fff;
      }

      #bgVideo {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        object-position: center center;
        z-index: 0;
        display: none;
        pointer-events: none;
        background: transparent;
      }

      /* 时钟：使用 vw/vh 和 clamp 保持可读性 */
      #clock {
        position: absolute;
        left: 5vw;
        top: 6.5vh;

        color: #fff;
        z-index: 2;
        cursor: pointer;
        user-select: none;
      }
      #clock .date {
        font-size: clamp(0.7rem, 1.2vw, 1.2rem);
        opacity: 0.95;
        letter-spacing: 0.08em;
        text-align: center;
      }
      #clock .time {
        font-size: clamp(2rem, 7vw, 7rem); /* 随视口宽度缩放 */
        letter-spacing: 0.04em;
        line-height: 0.95;
      }

      #overlayText {
        position: fixed;
        inset: 0;
        z-index: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        padding: 20px;
      }
      #overlayText::before {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.22);
        z-index: -1;
        pointer-events: none;
      }

      #weatherBox {
        display: none;
        color: #fff;
        margin-left: 2.6vw;
        pointer-events: auto;
        
      }

      /* 多倒计时右上角列表 */
      .countdowns-panel {
        position: fixed;
        right: 18px;
        top: 18px;
        z-index: 50;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-end;
        pointer-events: auto;
      }
      .countdown-card {
        min-width: 18vw;
        max-width: 30vw;
        background: rgba(0, 0, 0, 0.55);
        color: #fff;
        padding: 12px 12px;
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        gap: 10px;
        border-left: 6px solid transparent;
      }
      .countdown-card .meta {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .countdown-card .label {
        font-weight: 700;
        font-size: 1rem;
      }
      .countdown-card .time {
        font-family: monospace;
        margin-top: 4px;
        font-size: 13px;
        color: #fffb;
      }
      .countdown-card .actions {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      /* 优先级颜色：通过 border-left 给予视觉提示 */
      .priority-very {
        border-left-color: #ff2e2e;
        background: rgba(255, 46, 46, 0.08);
      } /* <= 60s */
      .priority-high {
        border-left-color: #ff6b6b;
        background: rgba(255, 107, 107, 0.06);
      } /* <= 3600s */
      .priority-medium {
        border-left-color: #ffb86b;
        background: rgba(255, 184, 107, 0.04);
      } /* <= 86400s */
      .priority-normal {
        border-left-color: transparent;
      }

      #quoteBox {
        color: #fff;
        font-size: 28px;
        max-width: 90%;
        text-align: center;
        padding: 12px 18px;
        border-radius: 8px;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02)
        );
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.6);
        line-height: 1.35;
        pointer-events: auto;
        min-height: 48px;
        white-space: pre-wrap;
        word-break: break-word;
        z-index: 2;
      }

      /* drawer */
      .drawer-mask {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.42);
        z-index: 9999;
        display: none;
        backdrop-filter: blur(2px);
      }
      .drawer-panel {
        position: absolute;
        top: 0;
        right: 0;
        width: min(520px, 100vw);
        height: 100%;
        background: #fff;
        color: #222;
        overflow-y: auto;
        box-shadow: -12px 0 40px rgba(0, 0, 0, 0.25);
        transform: translateX(100%);
        transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 18px;
        -webkit-overflow-scrolling: touch;
      }
      .drawer-mask.show {
        display: block;
      }
      .drawer-panel.show {
        transform: translateX(0);
      }

      .btn {
        display: inline-block;
        width: 100%;
        margin-top: 10px;
        padding: 10px;
        text-align: center;
        background: #409eff;
        color: #fff;
        border-radius: 6px;
        cursor: pointer;
        user-select: none;
        border: none;
      }
      .small {
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        background: #fff;
        cursor: pointer;
        flex: 1;
        text-align: center;
      }
      .muted {
        color: #666;
        font-size: 13px;
        margin-top: 6px;
      }

      input[type='file'] {
        display: none;
      }
      textarea {
        width: 100%;
        resize: vertical;
        min-height: 56px;
      }
      pre#weatherRaw {
        max-height: 200px;
        overflow: auto;
        background: #0f1720;
        color: #d7fff3;
        padding: 8px;
        border-radius: 6px;
        font-size: 12px;
        white-space: pre-wrap;
      }

      .controls-row {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 36px;
        height: 36px;
        border-radius: 6px;
        border: none;
        background: rgba(0, 0, 0, 0.04);
        color: #444;
        font-size: 18px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .close-btn:hover {
        background: rgba(0, 0, 0, 0.06);
      }

      @media (max-width: 600px) {
        #clock .time {
          font-size: 48px;
        }
        .drawer-panel {
          padding: 14px;
          width: 100vw;
        }
        #quoteBox {
          font-size: 18px;
          padding: 10px 12px;
        }
      }

      /* weather svg */
      svg.weather-svg {
        display: none;
        vertical-align: middle;
        transition: opacity 300ms ease, transform 300ms ease;
        opacity: 0;
        transform: translateY(-6px);
      }
      svg.weather-svg.show {
        display: inline-block;
        opacity: 1;
        transform: translateY(0);
      }

      .icon-btn {
        background: transparent;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
        padding: 4px 6px;
        border-radius: 4px;
      }
      .icon-btn.danger {
        color: #ff7b7b;
      }
      /* 全屏按钮样式 */
      #fullscreenBtn {
        position: absolute;
        top: 12px;
        right: 60px;
        width: 36px;
        height: 36px;
        border-radius: 6px;
        border: none;
        background: rgba(0, 0, 0, 0.04);
        color: #444;
        font-size: 18px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* 全屏时把倒计时区域放大到更显眼（> 半屏）并放大卡片 */
      .countdowns-panel {
        transition: width 220ms ease, max-height 220ms ease;
        width: clamp(300px, 44vw, 760px);
      }
      body.is-fullscreen .countdowns-panel {
        width: min(72vw, 1100px); /* 全屏时占视口的 ~72%（可调整为更大） */
        top: 18px;
        right: 18px;
        max-height: calc(100vh - 36px);
      }

      /* 全屏时卡片更大、更易读 */
      body.is-fullscreen .countdown-card {
        padding: 16px 18px;
        gap: 14px;
        border-left-width: 10px;
      }
      body.is-fullscreen .countdown-card .label {
        font-size: 20px;
      }
      body.is-fullscreen .countdown-card .time {
        font-size: 16px;
        margin-top: 8px;
      }

      /* weatherBox 细化布局（响应式，使用 vw/vh） */

/* 左侧：当前温度与描述 */
.wb-left {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 2px;
  min-width: 86px;
}
.wb-current-temp {
 
  /* responsive big number */
  font-size: 25px;
  line-height: 1;
}
.wb-current-desc {
  font-size: 14px;
  opacity: 0.95;
}

/* 中间图标（圆形/小）*/
.wb-icon-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  width: clamp(38px, 6.4vw, 64px);
  height: clamp(38px, 6.4vw, 64px);
  flex-shrink: 0;
}
#wxSmallIcon {
  max-width: 100%;
  max-height: 100%;
  display: block;
}

/* 右侧：明日温度与简短描述 */
.wb-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
  min-width: 120px;
  padding-top: 4px;
}

.wb-tomorrow-desc {
  margin-top: 4px;
  font-size: 14px;
  opacity: 0.95;
}

/* 底部：城市 + aqi 与 明日标题等（单行布局） */
.wb-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  margin-top: 6px;
  gap: 8px;
  font-size: clamp(11px, 1.6vw, 13px);
}
.wb-city-aqi { display:flex; gap:8px; align-items:center; color:#fff; }
.wb-aqi { color:#2ee39a; font-weight:700; }
.wb-phrase { opacity:0.9; }

    </style>
  </head>
  <body>
    <video id="bgVideo" autoplay muted loop playsinline></video>

    <div id="clock" title="点击打开设置">
      <div class="date"></div>
      <div class="time"></div>

      <div style="display: flex; justify-content: center; align-items: center;  margin-top: 10px;">
 <!-- weather svgs -->
      <svg class="weather-svg sunshine" aria-hidden="true" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="4" fill="#FFD54A"></circle>
        <g fill="#FFD54A" opacity="0.9">
          <rect x="11.4" y="1" width="1.2" height="4.2" rx="0.6" />
          <rect x="11.4" y="18.8" width="1.2" height="4.2" rx="0.6" />
          <rect x="1" y="11.4" width="4.2" height="1.2" rx="0.6" />
          <rect x="18.8" y="11.4" width="4.2" height="1.2" rx="0.6" />
          <rect
            x="3.2"
            y="3.2"
            width="1.2"
            height="4.2"
            transform="rotate(-45 3.2 3.2)"
          ></rect>
        </g>
      </svg>

      <svg
        class="weather-svg sun-cloud"
        aria-hidden="true"
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        viewBox="0 0 512 512"
      >
        <path
          class="sun-half"
          d="M127.8,259.1c3.1-4.3,6.5-8.4,10-12.3c-6-11.2-9.4-24-9.4-37.7c0-44.1,35.7-79.8,79.8-79.8
        c40,0,73.1,29.4,78.9,67.7c11.4,2.3,22.4,5.7,32.9,10.4c-0.4-29.2-12-56.6-32.7-77.3C266.1,109,238,97.4,208.2,97.4
        c-29.9,0-57.9,11.6-79.1,32.8c-21.1,21.1-32.8,49.2-32.8,79.1c0,17.2,3.9,33.9,11.2,48.9c1.5-0.1,3-0.1,4.4-0.1
        C117.3,258,122.6,258.4,127.8,259.1z"
        ></path>
        <path
          class="cloud"
          d="M400,256c-5.3,0-10.6,0.4-15.8,1.1c-16.8-22.8-39-40.5-64.2-51.7c-10.5-4.6-21.5-8.1-32.9-10.4
        c-10.1-2-20.5-3.1-31.1-3.1c-45.8,0-88.4,19.6-118.2,52.9c-3.5,3.9-6.9,8-10,12.3c-5.2-0.8-10.5-1.1-15.8-1.1c-1.5,0-3,0-4.4,0.1
        C47.9,258.4,0,307.7,0,368c0,61.8,50.2,112,112,112c13.7,0,27.1-2.5,39.7-7.3c29,25.2,65.8,39.3,104.3,39.3
        c38.5,0,75.3-14.1,104.3-39.3c12.6,4.8,26,7.3,39.7,7.3c61.8,0,112-50.2,112-112S461.8,256,400,256z M400,448
        c-17.1,0-32.9-5.5-45.9-14.7C330.6,461.6,295.6,480,256,480c-39.6,0-74.6-18.4-98.1-46.7c-13,9.2-28.8,14.7-45.9,14.7
        c-44.2,0-80-35.8-80-80s35.8-80,80-80c7.8,0,15.4,1.2,22.5,3.3c2.7,0.8,5.4,1.7,8,2.8c4.5-8.7,9.9-16.9,16.2-24.4
        C182,241.9,216.8,224,256,224c10.1,0,20,1.2,29.4,3.5c10.6,2.5,20.7,6.4,30.1,11.4c23.2,12.4,42.1,31.8,54.1,55.2
        c9.4-3.9,19.7-6.1,30.5-6.1c44.2,0,80,35.8,80,80S444.2,448,400,448z"
        ></path>

        <path
          class="ray ray-one"
          d="M16,224h32c8.8,0,16-7.2,16-16s-7.2-16-16-16H16c-8.8,0-16,7.2-16,16S7.2,224,16,224z"
        ></path>
        <path
          class="ray ray-two"
          d="M83.5,106.2c6.3,6.2,16.4,6.2,22.6,0c6.3-6.2,6.3-16.4,0-22.6L83.5,60.9c-6.2-6.2-16.4-6.2-22.6,0
        c-6.2,6.2-6.2,16.4,0,22.6L83.5,106.2z"
        ></path>
        <path
          class="ray ray-three"
          d="M208,64c8.8,0,16-7.2,16-16V16c0-8.8-7.2-16-16-16s-16,7.2-16,16v32C192,56.8,199.2,64,208,64z"
        ></path>
        <path
          class="ray ray-four"
          d="M332.4,106.2l22.6-22.6c6.2-6.2,6.2-16.4,0-22.6c-6.2-6.2-16.4-6.2-22.6,0l-22.6,22.6
        c-6.2,6.2-6.2,16.4,0,22.6S326.2,112.4,332.4,106.2z"
        ></path>
        <path
          class="ray ray-five"
          d="M352,208c0,8.8,7.2,16,16,16h32c8.8,0,16-7.2,16-16s-7.2-16-16-16h-32C359.2,192,352,199.2,352,208z"
        ></path>
      </svg>

      <svg
        class="weather-svg windy-cloud"
        aria-hidden="true"
        viewBox="0 0 24 24"
      >
        <path
          d="M2 7h12a2 2 0 110 4H6"
          stroke="#A6B3C9"
          stroke-width="1.6"
          fill="none"
          stroke-linecap="round"
        />
        <path
          d="M4 13h9"
          stroke="#A6B3C9"
          stroke-width="1.6"
          fill="none"
          stroke-linecap="round"
        />
      </svg>

      <svg
        class="weather-svg rain-cloud"
        aria-hidden="true"
        viewBox="0 0 24 24"
      >
        <path
          d="M5 15a4 4 0 014-4h6a4 4 0 010 8H9a4 4 0 01-4-4z"
          fill="#E0E7FF"
        ></path>
        <g stroke="#4DA0FF" stroke-width="1.8" stroke-linecap="round">
          <path d="M9 20v2"></path>
          <path d="M12 20v3"></path>
          <path d="M15 20v2"></path>
        </g>
      </svg>

      <svg
        class="weather-svg thunder-cloud"
        aria-hidden="true"
        viewBox="0 0 24 24"
      >
        <path
          d="M6 14a4 4 0 014-4h6a4 4 0 010 8H10a4 4 0 01-4-4z"
          fill="#DDE7FF"
        ></path>
        <path d="M13 18l-2 4 4-1-2 4" fill="#FFD15A"></path>
      </svg>

      <svg
        class="weather-svg snow-cloud"
        aria-hidden="true"
        viewBox="0 0 24 24"
      >
        <path
          d="M5 15a4 4 0 014-4h6a4 4 0 010 8H9a4 4 0 01-4-4z"
          fill="#E8F0FF"
        ></path>
        <g stroke="#BFD8FF" stroke-width="1.6" stroke-linecap="round">
          <path d="M9 20l0.5 0.5 M9 20l-0.5 0.5"></path>
          <path d="M12 20l0.5 0.5 M12 20l-0.5 0.5"></path>
          <path d="M15 20l0.5 0.5 M15 20l-0.5 0.5"></path>
        </g>
      </svg>
      <span id="weatherBox">
        <span id="weatherSummary"></span>
      </span>
      </div>

     
    </div>

    </div>

    <div id="overlayText" aria-hidden="false">
      <div id="quoteBox"></div>
    </div>

    <!-- 多倒计时面板 -->
    <div class="countdowns-panel" id="countdownsPanel" aria-live="polite"></div>

    <!-- drawer -->
    <div id="drawerMask" class="drawer-mask" aria-hidden="true">
      <div
        id="drawerPanel"
        class="drawer-panel"
        role="dialog"
        aria-modal="true"
        aria-hidden="true"
      >
        <button id="closeDrawerBtn" class="close-btn" aria-label="关闭设置">
          ✕
        </button>
        <h2 style="margin-bottom: 6px">
          设置（背景 / 倒计时 / 励志语 / 天气）
        </h2>
        <button id="fullscreenBtn" title="切换全屏">切换全屏</button>

        <div class="drawer-section">
          <h3>背景</h3>
          <label class="btn" for="pickImg">选择图片背景（本地）</label>
          <input id="pickImg" type="file" accept="image/*" />
          <label class="btn" for="pickVideo" style="background: #5a9bd6"
            >选择视频背景（本地）</label
          >
          <input id="pickVideo" type="file" accept="video/*" />

          <div style="margin-top: 10px">
            <strong>或通过 URL 设置（图片 / 视频）</strong>
            <div style="display: flex; gap: 8px; margin-top: 8px">
              <input
                id="bgImageUrl"
                placeholder="图片 URL，例如：https://..."
                style="
                  flex: 1;
                  padding: 8px;
                  border-radius: 6px;
                  border: 1px solid #ddd;
                "
              />
              <button id="applyBgImageUrl" class="small">应用</button>
            </div>
            <div style="display: flex; gap: 8px; margin-top: 8px">
              <input
                id="bgVideoUrl"
                placeholder="视频 URL（mp4/webm）例如：https://..."
                style="
                  flex: 1;
                  padding: 8px;
                  border-radius: 6px;
                  border: 1px solid #ddd;
                "
              />
              <button id="applyBgVideoUrl" class="small">应用</button>
            </div>
            <div class="muted">视频跨域或服务器限制可能导致无法播放。</div>
          </div>

          <div style="margin-top: 10px">
            <strong>展示模式：</strong>
            <label style="margin-left: 10px"
              ><input type="radio" name="bgMode" value="cover" />
              铺满（cover）</label
            >
            <label style="margin-left: 10px"
              ><input type="radio" name="bgMode" value="contain" />
              完整（contain）</label
            >
          </div>
          <div class="muted">
            图片保存到 localStorage（可能失败）。视频 ≤5MB 保存到
            localStorage，>5MB 刷新后不可恢复。
          </div>
        </div>

        <div class="drawer-section">
          <h3>倒计时（支持多项，支持编辑 / 删除 / 优先级颜色）</h3>
          <div
            style="
              display: flex;
              gap: 8px;
              align-items: center;
              margin-top: 8px;
            "
          >
            <input
              id="countdownLabel"
              placeholder="用途/名称，例如：语文考试结束"
              style="
                flex: 1;
                padding: 8px;
                border-radius: 6px;
                border: 1px solid #ddd;
              "
            />
          </div>
          <div
            style="
              display: flex;
              gap: 8px;
              align-items: center;
              margin-top: 8px;
            "
          >
            <input
              id="countdownDate"
              type="datetime-local"
              style="
                flex: 1;
                padding: 8px;
                border-radius: 6px;
                border: 1px solid #ddd;
              "
            />
            <button id="addCountdownBtn" class="small">添加</button>
          </div>
          <div class="muted" style="margin-top: 8px">
            添加后会出现在右上角列表，页面刷新后自动恢复（保存在
            localStorage）。
          </div>

          <div style="margin-top: 10px">
            <strong>已保存的倒计时</strong>
            <div id="savedCountdownsList" style="margin-top: 8px"></div>
          </div>
        </div>

        <div class="drawer-section">
          <h3>励志语（打字机效果）</h3>
          <textarea
            id="newQuoteText"
            rows="2"
            placeholder="输入一条励志语..."
          ></textarea>
          <div class="controls-row" style="margin-top: 8px">
            <button id="addQuoteBtn" class="small">添加</button>
            <button
              id="clearQuotesBtn"
              class="small"
              style="background: #f56c6c; color: #fff"
            >
              清空
            </button>
          </div>
          <div class="quote-list" id="quoteList"></div>
          <div class="muted">励志语会按顺序轮播并带打字机效果。</div>
        </div>

        <div class="drawer-section">
          <h3>天气（每 1 小时自动刷新 — 使用 IP 获取）</h3>
          <div style="margin-top: 6px">
            <button id="getWeatherBtn" class="small">
              获取当前天气（通过公网 IP）
            </button>
          </div>

          <div style="margin-top: 10px">
            <label style="font-weight: 600">手动输入 IP（可保存）</label>
            <div style="display: flex; gap: 8px; margin-top: 8px">
              <input
                id="manualIp"
                placeholder="公网 IP，例如：49.234.56.78"
                style="
                  flex: 1;
                  padding: 8px;
                  border-radius: 6px;
                  border: 1px solid #ddd;
                "
              />
              <button id="saveIpBtn" class="small">保存并获取</button>
            </div>
            <div class="controls-row" style="margin-top: 8px">
              <button
                id="clearIpBtn"
                class="small"
                style="background: #f56c6c; color: #fff"
              >
                清除 IP
              </button>
            </div>
            <div class="muted" style="margin-top: 8px">
              已保存 IP（键：<code>app_weather_ip</code>），最近一次天气保存在
              <code>app_weather_last</code>。
            </div>
          </div>

          <div style="margin-top: 10px">
            <strong>已保存 IP：</strong>
            <div id="savedIp" class="muted" style="margin-top: 6px">
              （尚未保存）
            </div>
            <div style="margin-top: 6px">
              <strong>上次刷新：</strong
              ><span id="weatherLast" class="muted">（尚未刷新）</span>
            </div>
          </div>

          <div style="margin-top: 10px">
            <strong>接口返回（调试）</strong>
            <pre id="weatherRaw">尚未获取</pre>
          </div>
        </div>

        <div class="drawer-section">
          <h3>重置</h3>
          <div class="muted" style="margin-bottom: 8px">
            重置将清除背景、倒计时、励志语、天气缓存与展示模式。
          </div>
          <button
            id="resetAllBtn"
            class="btn"
            style="background: #333; margin-top: 6px"
          >
            重置所有设置
          </button>
        </div>

        <div style="height: 40px"></div>
      </div>
    </div>

    <script>
      /*******************************
       * Keys & DOM
       *******************************/
      const KEY_BG_IMAGE = 'app_bg_image_data';
      const KEY_BG_VIDEO = 'app_bg_video_data';
      const KEY_BG_MODE = 'app_bg_mode';
      const KEY_QUOTES = 'app_quotes_list';
      const KEY_WEATHER_IP = 'app_weather_ip';
      const KEY_WEATHER_LAST = 'app_weather_last';
      const KEY_COUNTDOWNS = 'app_countdowns_list';

      const dateEl = document.querySelector('#clock .date');
      const timeEl = document.querySelector('#clock .time');
      const clockEl = document.getElementById('clock');
      const bgVideo = document.getElementById('bgVideo');
      const weatherBox = document.getElementById('weatherBox');
      const weatherIcon = document.getElementById('weatherIcon');
      const weatherSummary = document.getElementById('weatherSummary');
      const weatherRawPre = document.getElementById('weatherRaw');
      const savedIpEl = document.getElementById('savedIp');
      const weatherLastEl = document.getElementById('weatherLast');

      const drawerMask = document.getElementById('drawerMask');
      const drawerPanel = document.getElementById('drawerPanel');
      const closeDrawerBtn = document.getElementById('closeDrawerBtn');

      const pickImg = document.getElementById('pickImg');
      const pickVideo = document.getElementById('pickVideo');
      const modeRadios = document.getElementsByName('bgMode');
      const bgImageUrlInput = document.getElementById('bgImageUrl');
      const applyBgImageUrlBtn = document.getElementById('applyBgImageUrl');
      const bgVideoUrlInput = document.getElementById('bgVideoUrl');
      const applyBgVideoUrlBtn = document.getElementById('applyBgVideoUrl');

      const countdownLabelInput = document.getElementById('countdownLabel');
      const countdownDateInput = document.getElementById('countdownDate');
      const addCountdownBtn = document.getElementById('addCountdownBtn');
      const savedCountdownsList = document.getElementById(
        'savedCountdownsList'
      );
      const countdownsPanel = document.getElementById('countdownsPanel');

      const newQuoteText = document.getElementById('newQuoteText');
      const addQuoteBtn = document.getElementById('addQuoteBtn');
      const clearQuotesBtn = document.getElementById('clearQuotesBtn');
      const quoteListEl = document.getElementById('quoteList');
      const quoteBox = document.getElementById('quoteBox');

      const getWeatherBtn = document.getElementById('getWeatherBtn');
      const manualIp = document.getElementById('manualIp');
      const saveIpBtn = document.getElementById('saveIpBtn');
      const clearIpBtn = document.getElementById('clearIpBtn');
      const resetAllBtn = document.getElementById('resetAllBtn');

      let lastObjectURL = null;
      let weatherAutoTimer = null;
      function revokeLastURL() {
        if (lastObjectURL) {
          try {
            URL.revokeObjectURL(lastObjectURL);
          } catch (e) {}
          lastObjectURL = null;
        }
      }
      function safeSetItem(k, v) {
        try {
          localStorage.setItem(k, v);
          return true;
        } catch (e) {
          console.warn('localStorage set failed', e);
          return false;
        }
      }

      /*******************************
       * Clock
       *******************************/
      function updateClock() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        const weekArr = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const w = weekArr[now.getDay()];
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        dateEl.textContent = `${y}-${m}-${d} ${w}`;
        timeEl.textContent = `${hh}:${mm}:${ss}`;
      }
      updateClock();
      setInterval(updateClock, 1000);

      /*******************************
       * Drawer open/close
       *******************************/
      function openDrawer() {
        drawerMask.classList.add('show');
        drawerPanel.classList.add('show');
        drawerMask.setAttribute('aria-hidden', 'false');
        drawerPanel.setAttribute('aria-hidden', 'false');
        drawerMask.addEventListener('click', maskClickHandler);
      }
      function closeDrawer() {
        drawerMask.classList.remove('show');
        drawerPanel.classList.remove('show');
        drawerMask.setAttribute('aria-hidden', 'true');
        drawerPanel.setAttribute('aria-hidden', 'true');
        drawerMask.removeEventListener('click', maskClickHandler);
      }
      function maskClickHandler(e) {
        if (e.target === drawerMask) closeDrawer();
      }
      clockEl.addEventListener('click', openDrawer);
      closeDrawerBtn.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeDrawer();
      });

      /*******************************
       * Background (file & url)
       *******************************/
      function applyMode(mode) {
        if (document.body.style.backgroundImage) {
          document.body.style.backgroundSize =
            mode === 'cover' ? 'cover' : 'contain';
          document.body.style.backgroundRepeat = 'no-repeat';
          document.body.style.backgroundPosition = 'center center';
          if (bgVideo.style.display === 'block')
            document.body.style.backgroundColor = 'transparent';
          else
            document.body.style.backgroundColor =
              mode === 'contain' ? '#000' : 'transparent';
        }
        if (bgVideo.style.display !== 'none') {
          bgVideo.style.objectFit = mode === 'cover' ? 'cover' : 'contain';
          document.body.style.backgroundColor = 'transparent';
        }
        safeSetItem(KEY_BG_MODE, mode);
      }
      (function restoreModeUI() {
        const saved = localStorage.getItem(KEY_BG_MODE) || 'cover';
        for (const r of modeRadios) r.checked = r.value === saved;
        applyMode(saved);
      })();
      for (const r of modeRadios)
        r.addEventListener('change', () => {
          const v = document.querySelector(
            'input[name="bgMode"]:checked'
          ).value;
          applyMode(v);
        });

      pickImg.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (evt) {
          const dataURL = evt.target.result;
          revokeLastURL();
          document.body.style.backgroundImage = `url("${dataURL}")`;
          const mode = localStorage.getItem(KEY_BG_MODE) || 'cover';
          document.body.style.backgroundSize =
            mode === 'cover' ? 'cover' : 'contain';
          document.body.style.backgroundPosition = 'center center';
          document.body.style.backgroundRepeat = 'no-repeat';
          try {
            bgVideo.pause();
            bgVideo.removeAttribute('src');
            bgVideo.load();
          } catch (e) {}
          bgVideo.style.display = 'none';
          if (!safeSetItem(KEY_BG_IMAGE, dataURL)) {
            alert('图片过大，无法保存到 localStorage，但本次会话仍会显示。');
            localStorage.removeItem(KEY_BG_IMAGE);
          } else localStorage.removeItem(KEY_BG_VIDEO);
        };
        reader.readAsDataURL(file);
        e.target.value = '';
      });

      pickVideo.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const maxPersist = 5 * 1024 * 1024;
        if (file.size <= maxPersist) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            const dataURL = evt.target.result;
            revokeLastURL();
            bgVideo.src = dataURL;
            bgVideo.style.display = 'block';
            const mode = localStorage.getItem(KEY_BG_MODE) || 'cover';
            bgVideo.style.objectFit = mode === 'cover' ? 'cover' : 'contain';
            bgVideo.muted = true;
            bgVideo.play().catch(() => {});
            document.body.style.backgroundImage = '';
            if (!safeSetItem(KEY_BG_VIDEO, dataURL)) {
              alert(
                '视频无法保存到 localStorage（可能过大），但本次会话会播放。'
              );
              localStorage.removeItem(KEY_BG_VIDEO);
            } else localStorage.removeItem(KEY_BG_IMAGE);
          };
          reader.readAsDataURL(file);
        } else {
          revokeLastURL();
          const url = URL.createObjectURL(file);
          lastObjectURL = url;
          bgVideo.src = url;
          bgVideo.style.display = 'block';
          const mode = localStorage.getItem(KEY_BG_MODE) || 'cover';
          bgVideo.style.objectFit = mode === 'cover' ? 'cover' : 'contain';
          bgVideo.muted = true;
          bgVideo.play().catch(() => {});
          document.body.style.backgroundImage = '';
          localStorage.removeItem(KEY_BG_VIDEO);
          localStorage.removeItem(KEY_BG_IMAGE);
          alert(
            '视频体积较大（>5MB），无法保存到 localStorage，刷新后将无法恢复该视频。'
          );
        }
        e.target.value = '';
      });

      applyBgImageUrlBtn.addEventListener('click', () => {
        const url = (bgImageUrlInput.value || '').trim();
        if (!url) {
          alert('请输入图片 URL');
          return;
        }
        try {
          revokeLastURL();
          document.body.style.backgroundImage = `url("${url}")`;
          document.body.style.backgroundSize =
            (localStorage.getItem(KEY_BG_MODE) || 'cover') === 'cover'
              ? 'cover'
              : 'contain';
          document.body.style.backgroundPosition = 'center center';
          document.body.style.backgroundRepeat = 'no-repeat';
          try {
            bgVideo.pause();
            bgVideo.removeAttribute('src');
            bgVideo.load();
          } catch (e) {}
          bgVideo.style.display = 'none';
          safeSetItem(KEY_BG_IMAGE, url);
          localStorage.removeItem(KEY_BG_VIDEO);
          alert('已应用图片 URL 作为背景');
        } catch (e) {
          console.error(e);
          alert('应用图片 URL 失败');
        }
      });

      applyBgVideoUrlBtn.addEventListener('click', () => {
        const url = (
          bgVideoUrlInput.value ||
          'https://wisdomhallsup.oss-cn-beijing.aliyuncs.com/798.mp4'
        ).trim();
        if (!url) {
          alert('请输入视频 URL');
          return;
        }
        try {
          revokeLastURL();
          bgVideo.src = url;
          bgVideo.style.display = 'block';
          bgVideo.muted = true;
          bgVideo.play().catch(() => {});
          document.body.style.backgroundImage = '';
          safeSetItem(KEY_BG_VIDEO, url);
          localStorage.removeItem(KEY_BG_IMAGE);
          alert('已应用视频 URL 作为背景（若无法播放请检查跨域与格式）');
        } catch (e) {
          console.error(e);
          alert('应用视频 URL 失败');
        }
      });

      function restoreBackground() {
        const img = localStorage.getItem(KEY_BG_IMAGE);
        const vid = localStorage.getItem(KEY_BG_VIDEO);
        const mode = localStorage.getItem(KEY_BG_MODE) || 'cover';
        if (img) {
          document.body.style.backgroundImage = `url("${img}")`;
          document.body.style.backgroundSize =
            mode === 'cover' ? 'cover' : 'contain';
          document.body.style.backgroundPosition = 'center center';
          document.body.style.backgroundRepeat = 'no-repeat';
          document.body.style.backgroundColor =
            mode === 'contain' ? '#000' : 'transparent';
          bgVideo.style.display = 'none';
        } else if (vid) {
          bgVideo.src = vid;
          bgVideo.style.display = 'block';
          bgVideo.style.objectFit = mode === 'cover' ? 'cover' : 'contain';
          bgVideo.muted = true;
          bgVideo.play().catch(() => {});
          document.body.style.backgroundImage = '';
          document.body.style.backgroundColor = 'transparent';
        } else {
          document.body.style.backgroundImage = '';
          document.body.style.backgroundColor = '#000';
          bgVideo.style.display = 'none';
        }
      }
      restoreBackground();

      /*******************************
       * Countdown: load/save & helpers
       *******************************/
      function loadCountdowns() {
        try {
          const raw = localStorage.getItem(KEY_COUNTDOWNS);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          return Array.isArray(arr) ? arr : [];
        } catch (e) {
          console.warn('loadCountdowns error', e);
          return [];
        }
      }
      function saveCountdowns(list) {
        try {
          localStorage.setItem(KEY_COUNTDOWNS, JSON.stringify(list));
        } catch (e) {
          console.warn('saveCountdowns error', e);
          alert('倒计时保存失败');
        }
      }

      // returns remaining object or null if ended
      function computeRemaining(ts) {
        const remaining = ts - Date.now();
        if (remaining <= 0) return null;
        const totalSec = Math.floor(remaining / 1000);
        const days = Math.floor(totalSec / (3600 * 24));
        const hours = Math.floor((totalSec % (3600 * 24)) / 3600);
        const mins = Math.floor((totalSec % 3600) / 60);
        const secs = totalSec % 60;
        return { days, hours, mins, secs, totalSec };
      }
      function formatRemainingStr(ts) {
        const r = computeRemaining(ts);
        if (!r) return '已结束';
        const hh = String(r.hours).padStart(2, '0');
        const mm = String(r.mins).padStart(2, '0');
        const ss = String(r.secs).padStart(2, '0');
        return r.days <= 0
          ? `${hh}:${mm}:${ss}`
          : `${r.days} 天 ${hh}:${mm}:${ss}`;
      }

      // priority class
      function getPriorityClass(ts) {
        const r = computeRemaining(ts);
        if (!r) return 'priority-very';
        if (r.totalSec <= 60) return 'priority-very';
        if (r.totalSec <= 3600) return 'priority-high';
        if (r.totalSec <= 86400) return 'priority-medium';
        return 'priority-normal';
      }

      /*******************************
       * Notification & Sound
       *******************************/
      // Request notification permission (call on first interaction)
      async function requestNotificationPermission() {
        try {
          if (!('Notification' in window)) return false;
          if (Notification.permission === 'granted') return true;
          if (Notification.permission === 'denied') return false;
          const res = await Notification.requestPermission();
          return res === 'granted';
        } catch (e) {
          console.warn('requestNotificationPermission error', e);
          return false;
        }
      }

      function showBrowserNotification(title, body) {
        try {
          if (!('Notification' in window)) return;
          if (Notification.permission === 'granted') {
            const n = new Notification(title, { body, silent: true });
            // close after 8s
            setTimeout(() => {
              try {
                n.close();
              } catch (e) {}
            }, 8000);
          }
        } catch (e) {
          console.warn('showBrowserNotification error', e);
        }
      }

      // beep sound via WebAudio
      function playBeep() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = 'sine';
          o.frequency.value = 880;
          g.gain.value = 0.0001;
          o.connect(g);
          g.connect(ctx.destination);

          // ramp up then down
          const now = ctx.currentTime;
          g.gain.cancelScheduledValues(now);
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.2, now + 0.02);
          o.start(now);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 1.2);
          setTimeout(() => {
            try {
              o.stop();
              ctx.close();
            } catch (e) {}
          }, 1400);
        } catch (e) {
          console.warn('playBeep failed', e);
        }
      }

      /*******************************
       * Trigger when single countdown ends
       *******************************/
      function handleCountdownEnd(item) {
        // Play beep and show notification
        try {
          playBeep();
          showBrowserNotification(
            item.label || '倒计时结束',
            `目标时间已到：${item.label || ''}`
          );
        } catch (e) {
          console.warn(e);
        }
      }

      /*******************************
       * Render countdown panels & saved list (with edit/delete)
       *******************************/
      function renderCountdownsPanel() {
        const list = loadCountdowns();
        countdownsPanel.innerHTML = '';
        if (!list || list.length === 0) return;
        list.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'countdown-card ' + getPriorityClass(item.ts);

          const meta = document.createElement('div');
          meta.className = 'meta';
          const lbl = document.createElement('div');
          lbl.className = 'label';
          lbl.textContent = item.label || '（未命名）';
          const t = document.createElement('div');
          t.className = 'time';
          t.textContent = formatRemainingStr(item.ts);
          meta.appendChild(lbl);
          meta.appendChild(t);

          const actions = document.createElement('div');
          actions.className = 'actions';
          const editBtn = document.createElement('button');
          editBtn.className = 'icon-btn';
          editBtn.title = '编辑';
          editBtn.textContent = '✎';
          editBtn.addEventListener('click', () => openEditCountdown(item.id));
          const delBtn = document.createElement('button');
          delBtn.className = 'icon-btn danger';
          delBtn.title = '删除';
          delBtn.textContent = '✕';
          delBtn.addEventListener('click', () => {
            if (!confirm('确认删除该倒计时？')) return;
            removeCountdown(item.id);
          });

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          card.appendChild(meta);
          card.appendChild(actions);
          countdownsPanel.appendChild(card);
        });
      }

      function renderSavedCountdownsList() {
        const list = loadCountdowns();
        savedCountdownsList.innerHTML = '';
        if (!list || list.length === 0) {
          savedCountdownsList.innerHTML = '<div class="muted">暂无倒计时</div>';
          return;
        }
        list.forEach((item) => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.justifyContent = 'space-between';
          row.style.alignItems = 'center';
          row.style.padding = '8px 0';
          row.style.borderBottom = '1px dashed #eee';
          const left = document.createElement('div');
          left.style.flex = '1';
          const title = document.createElement('div');
          title.style.fontWeight = '600';
          title.textContent = item.label;
          const sub = document.createElement('div');
          sub.className = 'muted';
          sub.style.fontSize = '12px';
          sub.textContent = '目标：' + new Date(item.ts).toLocaleString();
          left.appendChild(title);
          left.appendChild(sub);

          const right = document.createElement('div');
          // edit
          const editBtn = document.createElement('button');
          editBtn.className = 'small';
          editBtn.textContent = '编辑';
          editBtn.addEventListener('click', () => openEditCountdown(item.id));
          // delete
          const delBtn = document.createElement('button');
          delBtn.className = 'small';
          delBtn.style.marginLeft = '6px';
          delBtn.style.background = '#f56c6c';
          delBtn.style.color = '#fff';
          delBtn.textContent = '删除';
          delBtn.addEventListener('click', () => {
            if (!confirm('确认删除？')) return;
            removeCountdown(item.id);
          });
          right.appendChild(editBtn);
          right.appendChild(delBtn);

          row.appendChild(left);
          row.appendChild(right);
          savedCountdownsList.appendChild(row);
        });
      }

      function addCountdown() {
        const label = (countdownLabelInput.value || '').trim();
        const dt = (countdownDateInput.value || '').trim();
        if (!label) {
          alert('请输入倒计时用途/名称');
          return;
        }
        if (!dt) {
          alert('请选择目标时间');
          return;
        }
        const ts = new Date(dt).getTime();
        if (isNaN(ts) || ts <= Date.now()) {
          alert('请选择未来时间');
          return;
        }
        const list = loadCountdowns();
        const id = 'cd_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        list.push({ id, label, ts, notified: false });
        saveCountdowns(list);
        countdownLabelInput.value = '';
        countdownDateInput.value = '';
        renderSavedCountdownsList();
        renderCountdownsPanel();
        // ask notification permission proactively
        requestNotificationPermission().catch(() => {});
      }
      addCountdownBtn.addEventListener('click', addCountdown);

      function removeCountdown(id) {
        let list = loadCountdowns();
        list = list.filter((i) => i.id !== id);
        saveCountdowns(list);
        renderSavedCountdownsList();
        renderCountdownsPanel();
      }

      /*******************************
       * Edit countdown (prompt-based)
       *******************************/
      function openEditCountdown(id) {
        const list = loadCountdowns();
        const item = list.find((i) => i.id === id);
        if (!item) {
          alert('未找到该倒计时');
          return;
        }
        // 使用 prompt 简单实现编辑（可替换成 modal）
        const newLabel = prompt('编辑名称：', item.label || '');
        if (newLabel === null) return; // 取消
        const newDateStr = prompt(
          '编辑目标时间（ISO 或 本地格式，例如 2025-12-31T09:00 或 2025-12-31 09:00:00）：',
          new Date(item.ts).toISOString().slice(0, 16)
        );
        if (newDateStr === null) return; // 取消
        // 尝试解析时间
        let parsedTs = Date.parse(newDateStr);
        if (isNaN(parsedTs)) {
          // try replace space with T
          parsedTs = Date.parse(newDateStr.replace(' ', 'T'));
        }
        if (isNaN(parsedTs) || parsedTs <= Date.now()) {
          alert('日期无效或不是未来时间，编辑已取消。');
          return;
        }
        item.label = String(newLabel).trim() || item.label;
        item.ts = Number(parsedTs);
        item.notified = false; // reset notification flag
        saveCountdowns(list);
        renderSavedCountdownsList();
        renderCountdownsPanel();
      }

      /*******************************
       * Periodic tick: update UI, detect endings
       *******************************/
      // 每秒刷新右上显示并检测是否触发通知（只触发一次）
      setInterval(() => {
        const list = loadCountdowns();
        let changed = false;
        for (let item of list) {
          const r = computeRemaining(item.ts);
          if (!r) {
            // 已结束
            if (!item.notified) {
              // trigger only once
              item.notified = true;
              changed = true;
              try {
                handleCountdownEnd(item);
              } catch (e) {
                console.warn(e);
              }
            }
          } else {
            // 未结束：如果之前已通知（例如用户编辑回到未来），重置
            if (item.notified) {
              item.notified = false;
              changed = true;
            }
          }
        }
        if (changed) saveCountdowns(list);
        // 重新渲染 panels
        renderCountdownsPanel();
        renderSavedCountdownsList();
      }, 1000);

      /*******************************
       * Quotes (typing)
       *******************************/
      function loadQuotes() {
        const raw = localStorage.getItem(KEY_QUOTES);
        if (!raw) return [];
        try {
          return JSON.parse(raw);
        } catch (e) {
          return [];
        }
      }
      function saveQuotes(arr) {
        safeSetItem(KEY_QUOTES, JSON.stringify(arr));
      }
      function renderQuoteList() {
        const arr = loadQuotes();
        quoteListEl.innerHTML = '';
        if (arr.length === 0) {
          quoteListEl.innerHTML =
            '<div class="muted" style="margin-top:8px;">当前无励志语，添加几条吧。</div>';
          return;
        }
        arr.forEach((q, idx) => {
          const item = document.createElement('div');
          item.className = 'quote-item';
          item.style.display = 'flex';
          item.style.gap = '6px';
          item.style.alignItems = 'center';
          item.style.marginTop = '8px';
          item.style.background = '#f7f7f8';
          item.style.padding = '8px';
          item.style.borderRadius = '6px';
          const t = document.createElement('div');
          t.className = 'text';
          t.style.flex = '1';
          t.style.fontSize = '14px';
          t.style.color = '#222';
          t.textContent = q;
          const up = document.createElement('button');
          up.textContent = '↑';
          up.title = '上移';
          const down = document.createElement('button');
          down.textContent = '↓';
          down.title = '下移';
          const del = document.createElement('button');
          del.textContent = '✕';
          del.title = '删除';
          up.addEventListener('click', () => {
            if (idx === 0) return;
            const arr = loadQuotes();
            [arr[idx - 1], arr[idx]] = [arr[idx], arr[idx - 1]];
            saveQuotes(arr);
            renderQuoteList();
          });
          down.addEventListener('click', () => {
            const arr = loadQuotes();
            if (idx === arr.length - 1) return;
            [arr[idx + 1], arr[idx]] = [arr[idx], arr[idx + 1]];
            saveQuotes(arr);
            renderQuoteList();
          });
          del.addEventListener('click', () => {
            if (!confirm('确认删除该励志语？')) return;
            const arr = loadQuotes();
            arr.splice(idx, 1);
            saveQuotes(arr);
            renderQuoteList();
          });
          item.appendChild(t);
          item.appendChild(up);
          item.appendChild(down);
          item.appendChild(del);
          quoteListEl.appendChild(item);
        });
      }
      renderQuoteList();

      let quoteCyclePromise = null;
      let quoteCycleActive = true;
      const TYPING_SPEED = 40,
        ERASING_SPEED = 20,
        PAUSE_AFTER_TYPE = 1800,
        PAUSE_AFTER_ERASE = 300;
      function typeText(element, text) {
        return new Promise((res) => {
          element.textContent = '';
          let i = 0;
          function step() {
            if (!quoteCycleActive) {
              res();
              return;
            }
            if (i <= text.length - 1) {
              element.textContent += text.charAt(i);
              i++;
              setTimeout(step, TYPING_SPEED);
            } else res();
          }
          step();
        });
      }
      function eraseText(element) {
        return new Promise((res) => {
          let s = element.textContent || '';
          let i = s.length;
          function step() {
            if (!quoteCycleActive) {
              res();
              return;
            }
            if (i > 0) {
              element.textContent = s.substring(0, i - 1);
              i--;
              setTimeout(step, ERASING_SPEED);
            } else res();
          }
          step();
        });
      }
      async function quoteCycleLoop() {
        quoteCycleActive = true;
        const arr = loadQuotes();
        if (!arr || arr.length === 0) {
          quoteBox.textContent = '';
          return;
        }
        let idx = 0;
        while (quoteCycleActive) {
          const cur = loadQuotes();
          if (!cur || cur.length === 0) {
            quoteBox.textContent = '';
            break;
          }
          if (idx >= cur.length) idx = 0;
          const text = cur[idx];
          await typeText(quoteBox, text);
          if (!quoteCycleActive) break;
          await new Promise((r) => setTimeout(r, PAUSE_AFTER_TYPE));
          if (!quoteCycleActive) break;
          await eraseText(quoteBox);
          if (!quoteCycleActive) break;
          await new Promise((r) => setTimeout(r, PAUSE_AFTER_ERASE));
          idx++;
        }
        quoteCyclePromise = null;
      }
      function startQuoteCycleOnce() {
        if (quoteCyclePromise) return;
        quoteCyclePromise = (async () => {
          try {
            await quoteCycleLoop();
          } catch (e) {
            console.warn(e);
          }
          quoteCyclePromise = null;
        })();
      }
      function stopQuoteCycle() {
        quoteCycleActive = false;
        quoteCyclePromise = null;
      }
      if (loadQuotes().length > 0) startQuoteCycleOnce();
      addQuoteBtn.addEventListener('click', () => {
        const txt = (newQuoteText.value || '').trim();
        if (!txt) {
          alert('请输入励志语');
          return;
        }
        const arr = loadQuotes();
        arr.push(txt);
        saveQuotes(arr);
        newQuoteText.value = '';
        renderQuoteList();
        startQuoteCycleOnce();
      });
      clearQuotesBtn.addEventListener('click', () => {
        if (!confirm('确认清空所有励志语？')) return;
        saveQuotes([]);
        renderQuoteList();
        stopQuoteCycle();
        quoteBox.textContent = '';
      });

       /*******************************
       * Weather (IP-based)
       *******************************/
      const PUBLIC_WEATHER_ID = '88888888';
      const PUBLIC_WEATHER_KEY = '88888888';

      function extractWeatherSummary(json) {
        const result = { city:null, temp:null, desc:null, humidity:null, wind:null, icon:null, raw:json };
        function walk(obj){ if (!obj || typeof obj !== 'object') return; for (const k of Object.keys(obj)) { const v = obj[k]; const key = k.toLowerCase();
            if (!result.city && (key.includes('city')||key.includes('name')||key.includes('location')||key.includes('addr')||key.includes('county'))) if (typeof v === 'string') result.city = v;
            if (!result.temp && (key.includes('temp')||key.includes('tem')||key.includes('wendu')||key.includes('temperature'))) if (typeof v === 'number' || typeof v === 'string') result.temp = v;
            if (!result.desc && (key.includes('wea')||key.includes('weather')||key.includes('desc')||key.includes('text')||key.includes('info'))) if (typeof v === 'string') result.desc = v;
            if (!result.humidity && (key.includes('humidity')||key.includes('shidu'))) if (typeof v === 'number' || typeof v === 'string') result.humidity = v;
            if (!result.wind && (key.includes('wind')||key.includes('feng'))) if (typeof v === 'string') result.wind = v;
            if (!result.icon && (key.includes('icon')||key.includes('img')||key.includes('pict')||key.includes('image'))) if (typeof v === 'string') result.icon = v;
            if (typeof v === 'object') walk(v);
        } }
        walk(json); return result;
      }

      function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

      function showWeatherSummary(summary) {
        if (!summary) { weatherBox.style.display='none'; return; }
        const pieces = [];
        if (summary.city) pieces.push(`<strong>${escapeHtml(String(summary.city))}</strong>`);
        if (summary.temp != null) pieces.push(`${escapeHtml(String(summary.temp))} ℃`);
        if (summary.desc) pieces.push(escapeHtml(String(summary.desc)));
        if (summary.humidity) pieces.push(`湿度: ${escapeHtml(String(summary.humidity))}`);
        if (summary.wind) pieces.push(`风: ${escapeHtml(String(summary.wind))}`);
        weatherSummary.innerHTML = pieces.join(' · ');
       
        weatherBox.style.display = 'flex';
      }

      /* 新增：把接口返回的完整数据渲染为你要的布局：
         左：当前温度 + 描述；中：图标；右：明日温度 + 描述；下：城市 + AQI
         参数 dataJson 为接口返回的对象（包含 data 数组）
      */
      function renderWeatherBoxFromApi(dataJson) {
        if (!dataJson || typeof dataJson !== 'object') return;
        let summary = {};
        try { if (typeof extractWeatherSummary === 'function') summary = extractWeatherSummary(dataJson) || {}; } catch (e) { summary = {}; }

        const days = Array.isArray(dataJson.data) ? dataJson.data : [];
        const today = days[0] || null;
        const tomorrow = days[1] || null;

        // 计算当前温度：优先 summary.temp，否则用 today max 或 (min+max)/2
        let currentTemp = summary.temp;
        if (currentTemp == null && today) {
          const minT = parseFloat(today.min_degree);
          const maxT = parseFloat(today.max_degree);
          if (!Number.isNaN(minT) && !Number.isNaN(maxT)) {
            currentTemp = Math.round((minT + maxT) / 2);
          } else if (!Number.isNaN(maxT)) currentTemp = Math.round(maxT);
          else if (!Number.isNaN(minT)) currentTemp = Math.round(minT);
        }
        currentTemp = currentTemp == null ? '' : String(currentTemp);

        const currentDesc = (today && (today.day_weather_short || today.day_weather)) || summary.desc || '';
        const iconUrl = summary.icon || (today && (today.day_weather_url || today.day_weather_icon)) || '';

        let tomorrowTempStr = '';
        let tomorrowDesc = '';
        if (tomorrow) {
          const tmin = tomorrow.min_degree;
          const tmax = tomorrow.max_degree;
          if (tmin != null && tmax != null) tomorrowTempStr = `${tmin} / ${tmax} °C`;
          else if (tmax != null) tomorrowTempStr = `${tmax}`;
          tomorrowDesc = tomorrow.day_weather_short || tomorrow.day_weather || tomorrow.night_weather_short || '';
        }

        const city = dataJson.county || dataJson.county || (today && (today.county || '')) || '';
        const aqiNum = today && (today.day_wind_direction != null ? today.day_wind_direction : null);
        const aqiName = today && today.aqi_name ? today.aqi_name : (summary.aqiName || '');

        const html = `
          <div style="width:100%">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
              <div class="wb-left">
                <div class="wb-current-temp">${currentTemp !== '' ? currentTemp + '°C' : '—'} <span style="font-size:16px">${escapeHtml(currentDesc || '')}</span> </div>
                <div class="wb-current-desc">${escapeHtml(city || '')} <span style="margin-left:5px;">${escapeHtml(aqiNum || '')}</span> </div>
              </div>

             

              <div class="wb-right">
                <div class="wb-tomorrow-temp">${tomorrowTempStr ? escapeHtml(tomorrowTempStr) : '—'}</div>
                <div class="wb-tomorrow-desc">明日 ${escapeHtml(tomorrowDesc || '')}</div>
              </div>
            </div>
          </div>
        `;

        try {
          const summaryEl = document.getElementById('weatherSummary');
          if (summaryEl) summaryEl.innerHTML = html;
          const mainImg = document.getElementById('weatherIcon');
          if (mainImg) {
            if (iconUrl) { mainImg.src = iconUrl; mainImg.style.display = 'inline-block'; }
            else mainImg.style.display = 'none';
          }
          const box = document.getElementById('weatherBox');
          if (box) box.style.display = 'flex';
        } catch (e) {
          console.warn('renderWeatherBoxFromApi error', e);
        }
      }

      async function fetchWeatherWithIP(ip) {
        const base = 'https://cn.apihz.cn/api/tianqi/tengxunip.php';
        const url = `${base}?id=${encodeURIComponent(PUBLIC_WEATHER_ID)}&key=${encodeURIComponent(PUBLIC_WEATHER_KEY)}&ip=${encodeURIComponent(ip)}`;
        weatherRawPre.textContent = '请求中...';
        try {
          const resp = await fetch(url);
          if (!resp.ok) throw new Error('网络错误: ' + resp.status);
          const data = await resp.json();
          if(data.code == 200){
             weatherRawPre.textContent = JSON.stringify(data, null, 2);
          safeSetItem(KEY_WEATHER_LAST, JSON.stringify({ ts: Date.now(), query: { ip }, data }));
          safeSetItem(KEY_WEATHER_IP, ip);
          updateSavedIpUI(); updateLastFetchUI();
          const summary = extractWeatherSummary(data);
          showWeatherSummary(summary);
          if (typeof showSvgFromSummary === 'function') showSvgFromSummary(summary);
          // 新增：渲染详细天气布局（当前温度 + 明天温度）
          renderWeatherBoxFromApi(data);
          }
         
          return { ok:true, data };
        } catch (err) {
          console.error('fetchWeather error', err);
          weatherRawPre.textContent = '请求失败: ' + err.message;
          showWeatherSummary(null);
          if (typeof hideAllWeatherSVG === 'function') hideAllWeatherSVG();
          return { ok:false, error:err };
        }
      }

      async function detectPublicIp() {
        try {
          const resp = await fetch('https://api.ipify.org?format=json');
          if (!resp.ok) throw new Error('ipify 网络错误: ' + resp.status);
          const j = await resp.json(); return String(j.ip || '').trim();
        } catch (err) {
          console.warn('detectPublicIp failed', err);
          try {
            const resp2 = await fetch('https://ifconfig.co/json');
            if (!resp2.ok) return '';
            const j2 = await resp2.json();
            return String(j2.ip || '').trim();
          } catch (e) { return ''; }
        }
      }

      async function getWeatherHandler() {
        weatherRawPre.textContent = '正在检测公网 IP...';
        const ip = await detectPublicIp();
        if (!ip) { alert('无法检测到公网 IP，请手动输入 IP 并保存。'); weatherRawPre.textContent = '无法检测公网 IP'; return; }
        weatherRawPre.textContent = `已检测到公网 IP：${ip}，正在请求天气接口...`;
        await fetchWeatherWithIP(ip);
      }
      getWeatherBtn.addEventListener('click', getWeatherHandler);

      saveIpBtn.addEventListener('click', async ()=> {
        const ip = (manualIp.value || '').trim();
        if (!ip) { alert('请输入有效的公网 IP'); return; }
        safeSetItem(KEY_WEATHER_IP, ip); updateSavedIpUI();
        weatherRawPre.textContent = `手动保存：ip=${ip}，正在请求天气接口...`;
        await fetchWeatherWithIP(ip); closeDrawer();
      });

      clearIpBtn.addEventListener('click', ()=> {
        if (!confirm('确认清除已保存的 IP？')) return;
        localStorage.removeItem(KEY_WEATHER_IP); updateSavedIpUI(); manualIp.value = ''; alert('已清除保存的 IP');
      });

      async function fetchWeatherAutoOnce() {
        const ipRaw = localStorage.getItem(KEY_WEATHER_IP);
        if (ipRaw) {
          try {
            const ip = String(ipRaw).trim();
            if (ip) { await fetchWeatherWithIP(ip); try { manualIp.value = ip; } catch (e){} return; }
          } catch (e) {}
        }
        const detected = await detectPublicIp();
        if (!detected) { console.warn('无法自动检测公网 IP，等待用户手动输入或点击获取'); return; }
        try { manualIp.value = detected; } catch (e) {}
        await fetchWeatherWithIP(detected);
      }

      function startAutoWeatherHourly() { if (weatherAutoTimer) clearInterval(weatherAutoTimer); fetchWeatherAutoOnce(); weatherAutoTimer = setInterval(fetchWeatherAutoOnce, 60*60*1000); }

      function updateSavedIpUI() { const s = localStorage.getItem(KEY_WEATHER_IP); if (!s) { savedIpEl.textContent = '（尚未保存）'; return; } savedIpEl.textContent = `ip=${s}`; }
      function updateLastFetchUI() { const lastRaw = localStorage.getItem(KEY_WEATHER_LAST); if (!lastRaw) { weatherLastEl.textContent = '（尚未刷新）'; return; } try { const parsed = JSON.parse(lastRaw); const ts = parsed.ts || Date.now(); const d = new Date(ts); weatherLastEl.textContent = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; } catch (e) { weatherLastEl.textContent = '（解析失败）'; } }

      (function restoreWeatherUI(){ const last = localStorage.getItem(KEY_WEATHER_LAST); if (last) { try { const parsed = JSON.parse(last); weatherRawPre.textContent = JSON.stringify(parsed.data, null, 2); const summary = extractWeatherSummary(parsed.data); showWeatherSummary(summary); if (typeof showSvgFromSummary === 'function') showSvgFromSummary(summary); // 新增渲染
            try { renderWeatherBoxFromApi(parsed.data); } catch(e){} } catch (e) { weatherRawPre.textContent = '尚未获取'; } } else weatherRawPre.textContent = '尚未获取'; updateSavedIpUI(); updateLastFetchUI(); try { const ipRaw = localStorage.getItem(KEY_WEATHER_IP); if (ipRaw) manualIp.value = String(ipRaw); } catch (e) {} startAutoWeatherHourly(); })();

      /*******************************
       * SVG mapping (same as before)
       *******************************/
      (function(){
        window.hideAllWeatherSVG = function() { document.querySelectorAll('svg.weather-svg').forEach(el=>{ el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }); };
        try { hideAllWeatherSVG(); } catch(e){}
        function mapDescToType(desc) {
          if (!desc) return 'sunshine';
          const s = String(desc||'').toLowerCase();
          if (/thunder|storm|雷|闪电|雷阵雨/.test(s)) return 'thunder-cloud';
          if (/snow|下雪|雪|冰雹|sleet|hail/.test(s)) return 'snow-cloud';
          if (/rain|shower|下雨|阵雨|降雨|drizzle/.test(s)) return 'rain-cloud';
          if (/wind|windy|风|大风|狂风|breeze/.test(s)) return 'windy-cloud';
          if (/cloud|cloudy|overcast|多云|阴|云/.test(s)) { if (/partly|晴间|sunny intervals/.test(s)) return 'sun-cloud'; return 'sun-cloud'; }
          if (/sun|clear|晴|晴朗/.test(s)) return 'sunshine';
          return 'sunshine';
        }
        window.showSvgFromSummary = function(summary) {
          try {
            if (summary && summary.icon) { hideAllWeatherSVG(); if (weatherIcon) { weatherIcon.src = summary.icon; weatherIcon.style.display = 'inline-block'; } return; }
            const desc = (summary && (summary.desc || summary.text || '')) || '';
            const type = mapDescToType(desc);
            if (weatherIcon) weatherIcon.style.display = 'none';
            hideAllWeatherSVG();
            const el = document.querySelector('svg.weather-svg.' + type);
            if (el) { el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
          } catch (e) { console.warn('showSvgFromSummary failed', e); hideAllWeatherSVG(); }
        };
      })();
      /*******************************
       * Restore other & reset
       *******************************/
      (function restoreAll() {
        restoreBackground();
        renderQuoteList();
        if (loadQuotes().length > 0) startQuoteCycleOnce();
        renderSavedCountdownsList();
        renderCountdownsPanel();
      })();

      resetAllBtn.addEventListener('click', () => {
        if (
          !confirm(
            '确认重置所有设置？这将清除背景、倒计时、励志语、天气缓存与展示模式。'
          )
        )
          return;
        localStorage.removeItem(KEY_BG_IMAGE);
        localStorage.removeItem(KEY_BG_VIDEO);
        localStorage.removeItem(KEY_BG_MODE);
        localStorage.removeItem(KEY_COUNTDOWNS);
        localStorage.removeItem(KEY_QUOTES);
        localStorage.removeItem(KEY_WEATHER_IP);
        localStorage.removeItem(KEY_WEATHER_LAST);
        try {
          bgVideo.pause();
          bgVideo.removeAttribute('src');
          bgVideo.load();
        } catch (e) {}
        bgVideo.style.display = 'none';
        revokeLastURL();
        document.body.style.backgroundImage = '';
        document.body.style.backgroundColor = '#000';
        renderSavedCountdownsList();
        renderCountdownsPanel();
        stopQuoteCycle();
        saveQuotes([]);
        renderQuoteList();
        quoteBox.textContent = '';
        weatherRawPre.textContent = '尚未获取';
        weatherBox.style.display = 'none';
        savedIpEl.textContent = '（尚未保存）';
        weatherLastEl.textContent = '（尚未刷新）';
        if (weatherAutoTimer) {
          clearInterval(weatherAutoTimer);
          weatherAutoTimer = null;
        }
        manualIp.value = '';
        for (const r of modeRadios) r.checked = r.value === 'cover';
        safeSetItem(KEY_BG_MODE, 'cover');
        try {
          hideAllWeatherSVG();
        } catch (e) {}
        closeDrawer();
        alert('已重置所有设置为默认。');
      });

      window.addEventListener('beforeunload', () => {
        revokeLastURL();
        if (weatherAutoTimer) clearInterval(weatherAutoTimer);
      });

      /*******************************
       * Proactively request notification on first interaction
       *******************************/
      (function setupInteractionPermission() {
        function tryRequest() {
          // ask permission only once on first click of page
          requestNotificationPermission().catch(() => {});
          document.removeEventListener('click', tryRequest);
        }
        document.addEventListener('click', tryRequest);
      })();

      // ---------- 全屏切换逻辑 ----------
      (function () {
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        if (!fullscreenBtn) return;

        function hasNativeRequestFS(elem) {
          return !!(
            elem.requestFullscreen ||
            elem.webkitRequestFullscreen ||
            elem.mozRequestFullScreen ||
            elem.msRequestFullscreen
          );
        }

        async function requestFull(el) {
          const fn =
            el.requestFullscreen ||
            el.webkitRequestFullscreen ||
            el.mozRequestFullScreen ||
            el.msRequestFullscreen;
          if (!fn) throw new Error('浏览器不支持 requestFullscreen');
          return fn.call(el);
        }
        async function exitFull() {
          const fn =
            document.exitFullscreen ||
            document.webkitExitFullscreen ||
            document.mozCancelFullScreen ||
            document.msExitFullscreen;
          if (!fn) throw new Error('浏览器不支持 exitFullscreen');
          return fn.call(document);
        }

        // 同步 body class 与按钮图标
        function syncFullUI() {
          const isFull = !!(
            document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement
          );
          document.body.classList.toggle('is-fullscreen', isFull);
          fullscreenBtn.textContent = isFull ? '⤡' : '⤢';
          fullscreenBtn.title = isFull ? '退出全屏 (F)' : '进入全屏 (F)';
        }

        // 点击切换
        fullscreenBtn.addEventListener('click', async () => {
          try {
            const isFull = !!(
              document.fullscreenElement ||
              document.webkitFullscreenElement ||
              document.mozFullScreenElement ||
              document.msFullscreenElement
            );
            if (!isFull) {
              await requestFull(document.documentElement);
            } else {
              await exitFull();
            }
          } catch (err) {
            console.warn('全屏切换失败：', err);
            alert(
              '无法切换全屏：' +
                (err && err.message
                  ? err.message
                  : '请在支持全屏的浏览器中使用')
            );
          }
        });

        // 监听全屏变化（兼容厂商前缀）
        [
          'fullscreenchange',
          'webkitfullscreenchange',
          'mozfullscreenchange',
          'MSFullscreenChange',
        ].forEach((evt) => {
          document.addEventListener(evt, syncFullUI);
        });

        // 快捷键：按 F 切换（避免在 input/textarea 中触发）
        document.addEventListener('keydown', (e) => {
          const tag =
            (document.activeElement && document.activeElement.tagName) || '';
          if (
            (e.key === 'f' || e.key === 'F') &&
            !['INPUT', 'TEXTAREA'].includes(tag)
          ) {
            e.preventDefault();
            fullscreenBtn.click();
          }
        });

        // 初始同步（如果页面已在全屏）
        syncFullUI();
      })();
    </script>
  </body>
</html>
